<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>trvrm</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="/images/favicon.png" rel="icon">

<link rel="canonical" href="">
        <meta name="author" content="trvrm" />

    <!-- Open Graph tags -->
        <meta property="og:site_name" content="trvrm" />
        <meta property="og:type" content="website"/>
        <meta property="og:title" content="trvrm"/>
        <meta property="og:url" content=""/>
        <meta property="og:description" content="trvrm"/>


    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/tango.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
trvrm            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="/category/database.html">Database</a>
                        </li>
                        <li >
                            <a href="/category/software.html">Software</a>
                        </li>
                        <li >
                            <a href="/category/systems.html">Systems</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
            <article>
                <h2><a href="/configuring-systems-with-fabric-and-cuisine.html">Configuring Systems with Fabric and Cuisine</a></h2>
                
                
                <div class="entry-content">

                    <p>I've mentioned <a class="reference external" href="http://fabric.readthedocs.org/en/1.8/">Fabric</a> before on this blog.  Because so much of my development time is spent in Python, it makes
sense for me to look for system administration tools that are also written in Python.  Fabric fits the bill
perfectly, and allows me to run tasks remotely on multiple machines simultaneously.</p>
<p>A useful addition to Fabric is <a class="reference external" href="https://github.com/sebastien/cuisine">Cuisine</a>.  <strong>Cuisine is a small set of functions that sit on top of Fabric,
to abstract common administration operations such as file/dir operations, user/group creation,
package install/upgrade, making it easier to write portable administration and deployment scripts.</strong></p>

                    
                </div>  
                
                
            </article>
            <hr/>
            <article>
                <h2><a href="/ipython-with-python-3.html">IPython with Python 3</a></h2>
                
                
                <div class="entry-content">

                    <p>This took me longer than I was expecting.</p>
<p>In general when working with IPython I use <code class="code">
pip</code>
 rather than <code class="code">
apt-get</code>
, as
pip tends to have more up-to-date packages.</p>
<p>In the end I found the simplest thing to do was to set up IPython in an isolated
virtualenv environment.  The main trick is to let virtualenv know what version of
Python you want it to use by default.</p>
<div class="highlight"><pre>$ virtualenv --python<span class="o">=</span>python3.4 python_3_demo
$ <span class="nb">cd</span> python_3_demo/
$ <span class="nb">source</span> ./bin/activate
$ pip install ipython
$ ipython
</pre></div>
<div class="highlight"><pre><span class="n">Python</span> <span class="mf">3.4</span><span class="o">.</span><span class="mi">0</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Apr</span> <span class="mi">11</span> <span class="mi">2014</span><span class="p">,</span> <span class="mi">13</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">11</span><span class="p">)</span>
<span class="o">...</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">sys</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
<span class="mf">3.4</span><span class="o">.</span><span class="mi">0</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Apr</span> <span class="mi">11</span> <span class="mi">2014</span><span class="p">,</span> <span class="mi">13</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">11</span><span class="p">)</span>
<span class="p">[</span><span class="n">GCC</span> <span class="mf">4.8</span><span class="o">.</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
<p>And voila, I have Python 3 in the best Python interpreter ever built, I'm ready to
start wrapping my head around byte arrays and UTF-8 encodings.</p>

                    
                </div>  
                
                
            </article>
            <hr/>
            <article>
                <h2><a href="/logrotate.html">logrotate</a></h2>
                
                
                <div class="entry-content">

                    <p>I have a large, complex <a class="reference external" href="/postfix.html">mailing system</a> that processes
a significant amount of data every hour.  While I'm developing it, I want to know
what it's doing, and whether it's having any problems.  So I use the excellent
python <a class="reference external" href="https://docs.python.org/2/library/logging.html">logging</a> library to produce comprehensive monitoring data.</p>
<p>The only problem is that these log files can get pretty big.  And because I don't
know ahead of time when I'm going to need to hunt through them, I tend to leave
the logging system in a fairly verbose state.</p>
<p>Enter <a class="reference external" href="http://www.thegeekstuff.com/2010/07/logrotate-examples/">logrotate</a>.  This is a standard service on Ubuntu that regularly rotates
your log files, throwing away old data, compressing middle-age data, and leaving
young log files fresh and accessible.  Thus you are protected from
runaway log file growth and nasty calls in the middle of the night from your
monitoring service telling you that your server just died because the hard
drives were full.</p>
<p>A default ubuntu installation comes with logrotate already set up for various services.
If you don't have it, install it with <code class="code">
apt-get install logrotate</code>
, and
then it's mostly just a question of copying a file from <code class="code">
/etc/logrotate.d/</code>

and modifying it according to your needs.</p>
<p><code class="code">
vi /etc/logrotate.d/myservice</code>
</p>
<div class="highlight"><pre>/var/log/myservice/*.log <span class="o">{</span>
  rotate 7
  daily
  compress
  missingok
  notifempty
<span class="o">}</span>
</pre></div>
<p>And that's it!  The actually invocation of the <code class="code">
logrotate</code>
 command will
get triggered regularly by a script in /etc/cron.daily</p>
<p>You can also <strong>force</strong> a rotation, a useful option when testing out a new configuration,
via</p>
<div class="highlight"><pre>logrotate -f /etc/logrotate.d/myservice
</pre></div>
<p>One quick word of warning: if you're using the python <a class="reference external" href="https://docs.python.org/2/library/logging.html">logging</a> library, then
you'll want to use the <code class="code">
WatchedFileHandler</code>
 class.  If the logfile gets
rotated out while it's in use, WatchedFileHandler will notice this, close the file
stream and open a new one.</p>

                    
                </div>  
                
                
            </article>
            <hr/>
            <article>
                <h2><a href="/more-ractive.html">More Ractive</a></h2>
                
                
                <div class="entry-content">

                    <p>I've used <a class="reference external" href="http://www.ractivejs.org/">Ractive</a> for several projects recently.
It's been like a breath of fresh air.  I've been writing user interfaces of one
kind or another for more than a decade, and keeping <em>what's displayed to the user</em>
in sync with <em>what's stored in the data structures</em> has often been a source of
frustration.</p>
<p>In the javascript world, I've mostly used <a class="reference external" href="http://backbonejs.org/">backbone</a>  and
<a class="reference external" href="http://jquery.com/">jQuery</a> for creating interactive web pages.  While these
tools are very good at what they do, I still find myself writing a fair amount
of code to update data in the model whenever a user interacts with a control, and
to update the control displays whenever data in the model changes.</p>
<p>Enter <strong>Ractive</strong>.  It's not the only library to handle 2-way data binding - Angular,
Knockout and React all play in this space, but it's my current favourite.</p>
<p>Anyway, here's a little demo....</p>
<p>Given a ractive template like this:</p>
<div class="highlight"><pre><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Type in the boxes below.<span class="err">&lt;</span>\p&gt;
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;{{var1}}&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;{{var2}}&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Current values are var1:<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>{{var1}}<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>, var2:<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>{{var2}}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">on-click</span><span class="o">=</span><span class="s">&quot;changeme&quot;</span><span class="p">&gt;</span>Set var1<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</pre></div>
<p>and javascript like this:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">ractive</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Ractive</span><span class="p">({</span>
   <span class="nx">el</span><span class="o">:</span><span class="s2">&quot;#demo&quot;</span><span class="p">,</span>
   <span class="nx">template</span><span class="o">:</span><span class="nx">template</span><span class="p">,</span>
   <span class="nx">data</span><span class="o">:</span><span class="p">{</span><span class="nx">var1</span><span class="o">:</span><span class="s1">&#39;beeblebrox&#39;</span><span class="p">,</span><span class="nx">var2</span><span class="o">:</span><span class="s1">&#39;lintilla&#39;</span><span class="p">}</span>
<span class="p">});</span>
</pre></div>
<p>We get:</p>
<script src='//cdn.ractivejs.org/latest/ractive.js'></script>

<div id="demo" class="well"></div>
<script type="text/javascript">

     var template='<p>Type in the boxes below.<\p> \
                  <input class="form-control" value="{{var1}}">  \
                  <input class="form-control" value="{{var2}}">  \
                  <p>Current values are var1:<code>{{var1}}</code>, var2:<code>{{var2}}</p>\
                  <br><button class="btn btn-primary" on-click="changeme">Set var1</button>';

     var ractive = new Ractive({
        el:"#demo",
        template:template,
        data:{var1:'beeblebrox',var2:'lintilla'}
     });

     ractive.on('changeme',function(){
        ractive.set('var1','zarniwoop');
     });
</script><p>Neat, huh?  I haven't had to write any code to manually react to keyup, or change events
in the input controls - Ractive simply takes care of the fact that I refer to <code class="code">
var1</code>

in both the output paragraph and the control value, and binds the two elements together,
refreshing them whenever needed.</p>
<p>The code for responding to the button click is simply:</p>
<div class="highlight"><pre><span class="nx">ractive</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;changeme&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">ractive</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;var1&#39;</span><span class="p">,</span><span class="s1">&#39;zarniwoop&#39;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>By setting data in the underlying model, the user interface automatically updates,
again without any manual intervention.</p>
<div class="section" id="ui-development-might-be-fun-again">
<h2>UI development might be fun again....</h2>
<p>I have the same feeling on discovering Ractive that I had when I was first shown
jQuery.  All of a sudden, a bunch of boring, fiddly manual tasks are taken care
of in an intuitive way.  And unlike other frameworks, <em>all</em> ractive does is data-binding.
It doesn't try to be a control library, an AJAX toolkit or a Model-View-Controller
framework.  For those who like all-in-one solutions, this will be a weakness, but as
someone who believes in the unix philosophy of building systems from tools that
each do one thing well, I'm very impressed.</p>
</div>

                    
                </div>  
                
                
            </article>
            <hr/>
            <article>
                <h2><a href="/nginx-uwsgi-ubuntu-14.html">Nginx and UWSGI on Ubuntu 14</a></h2>
                
                
                <div class="entry-content">

                    <p>The documentation for Nginx and UWSGI is long and complex, but with ubuntu 14
it's actually pretty straightforward to get them up and running.</p>
<p>I present here a a setup that uses nginx and uwsgi emperor to host
multiple python web applications simultaneously on an ubuntu 14 machine.</p>
<p>First, the packages</p>
<div class="highlight"><pre>$ sudo apt-get install nginx
$ sudo apt-get install uwsgi uwsgi-emperor uwsgi-plugin-python
</pre></div>
<p>Our configuration files will now be under <code class="code">
/etc/nginx</code>
 and <code class="code">
/etc/uwsgi-emperor</code>
</p>
<p>You can start, stop, and reload nginx as follows:</p>
<div class="highlight"><pre>$ sudo service nginx start
$ sudo service nginx stop
$ sudo service nginx reload
</pre></div>
<p>The last command is useful when changing configuration settings.</p>
<p>Now set up a site by creating a file in <code class="code">
/etc/nginx/sites-available</code>
</p>
<div class="highlight"><pre><span class="c1">#/etc/nginx/sites-available/mysite</span>
server<span class="o">{</span>

    server_name     your_host_name<span class="p">;</span>

    location /app1 <span class="o">{</span>
        uwsgi_pass unix:/tmp/app1.socket<span class="p">;</span>
        include uwsgi_params<span class="p">;</span>
    <span class="o">}</span>
    location /app2 <span class="o">{</span>
        uwsgi_pass unix:/tmp/app2.socket<span class="p">;</span>
        include uwsgi_params<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>Then,</p>
<div class="highlight"><pre>$ sudo ln -s /etc/nginx/apps-available/mysite /etc/nginx/sites-enabled
</pre></div>
<div class="alert  alert-warning compound">
<p class="compound-first"><strong>Warning</strong></p>
<p class="compound-last">A previous version of this tutorial had the sockets placed in <code class="code">
/run/uwsgi</code>
.
This was a mistake, because under Ubuntu <code class="code">
/run</code>
 is mounted as a <code class="code">
tmpfs</code>
, and its content will be deleted on reboot
Your uwsgi sub-directory will vanish and the uwsgi services will not restart.</p>
</div>
<p>Next, set up your 'vassals' (<a class="reference external" href="http://uwsgi-docs.readthedocs.org/en/latest/Emperor.html">http://uwsgi-docs.readthedocs.org/en/latest/Emperor.html</a>)</p>
<p>Create  <code class="code">
/etc/uwsgi-emperor/vassals/app1.ini</code>
 as follows:</p>
<div class="highlight"><pre><span class="k">[uwsgi]</span>
<span class="na">plugin</span> <span class="o">=</span> <span class="s">python</span>
<span class="na">processes</span> <span class="o">=</span> <span class="s">2</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">/tmp/app1.socket</span>
<span class="na">chmod-socket</span> <span class="o">=</span> <span class="s">666</span>

<span class="na">chdir</span> <span class="o">=</span> <span class="s">/srv/app1</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">/srv/app1/main.py</span>

<span class="na">uid</span> <span class="o">=</span> <span class="s">www-data</span>
<span class="na">gid</span> <span class="o">=</span> <span class="s">www-data</span>
</pre></div>
<p>And for your second application, create  <code class="code">
/etc/uwsgi-emperor/vassals/app2.ini</code>
 as similarly:</p>
<div class="highlight"><pre><span class="k">[uwsgi]</span>
<span class="na">plugin</span> <span class="o">=</span> <span class="s">python</span>
<span class="na">processes</span> <span class="o">=</span> <span class="s">2</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">/tmp/app2.socket</span>
<span class="na">chmod-socket</span> <span class="o">=</span> <span class="s">666</span>

<span class="na">chdir</span> <span class="o">=</span> <span class="s">/srv/app1</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">/srv/app2/main.py</span>

<span class="na">uid</span> <span class="o">=</span> <span class="s">www-data</span>
<span class="na">gid</span> <span class="o">=</span> <span class="s">www-data</span>
</pre></div>
<p>The simple act of <em>creating</em> or touching a .ini file in <code class="code">
/etc/uwsgi-emperor/vassals</code>
 will cause
the emperor process to try to restart your application.</p>
<p>Of course, your applications don't exist yet, so let's create them.  The simplest wsgi
application can be only a few lines long:</p>
<p>Create <code class="code">
/srv/app1/main.py</code>
</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span><span class="s1">&#39;text/html&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;Hello World, I am app1&quot;</span><span class="p">]</span>
</pre></div>
<p>And <code class="code">
/srv/app2/main.py</code>
</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span><span class="s1">&#39;text/html&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;I, however, am app2. &quot;</span><span class="p">]</span>
</pre></div>
<p>And that's it!</p>
<p>Visiting <a class="reference external" href="http://your_host_name/app1">http://your_host_name/app1</a> or <a class="reference external" href="http://your_host_name/app2">http://your_host_name/app2</a> should return the text
you put in the python files.</p>

                    
                </div>  
                
                
            </article>
            <hr/>
            <article>
                <h2><a href="/pdf-generation-with-pelican.html">PDF Generation With Pelican</a></h2>
                
                
                <div class="entry-content">

                    <p>The existing documentation is a little unclear on this, because it says
you need to add <code class="code">
PDF_GENERATOR=True</code>
 to your <cite>pelicanconf.py</cite> file.</p>
<p>This advice is out of date: PDF generation has been moved to a plugin.</p>
<p>So you need to first make sure you have <code class="code">
rst2pdf</code>
 installed:</p>
<div class="highlight"><pre>$ sudo apt-get install rst2pdf
</pre></div>
<p>and then add the following to <code class="code">
pelicanconf.py</code>
</p>
<div class="highlight"><pre><span class="n">PLUGIN_PATH</span> <span class="o">=</span> <span class="s1">&#39;../pelican-plugins&#39;</span>  <span class="c1"># or wherever.</span>
<span class="n">PLUGINS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pdf&#39;</span><span class="p">]</span>
</pre></div>
<p>However, doing this seems to screw up the pygments highlighting on my regular
html output.  This is because deep in the rst2pdf code, in a file called <code class="code">
pygments2style.py</code>
,
all the pygment elements have their CSS classes prepended with <code class="code">
pygment-</code>
.  I haven't
figured out how to generate HTML and PDF nicely at the same time.</p>

                    
                </div>  
                
                
            </article>
            <hr/>
            <article>
                <h2><a href="/postfix.html">Postfix</a></h2>
                
                
                <div class="entry-content">

                    <p>Postfix is a ghastly horror that really should be quietly eliminated.  But that truism hides a deeper issue - email itself is a ghastly horror, the result of 30 years of hacks, edge-cases, non-conformant implementations and competing design constraints, that only persists because we still haven't come up with anything better.</p>
<p>Take the simple question 'what is a valid email address'.</p>
<p>I have a couple of standard regexes I use to validate email addresses,
such as <code class="code">
^[A-Z0-9._%+-]+&#64;[A-Z0-9.-]+ .[A-Z]{2,4}$</code>
,
but having spent years building mailing systems,
the best answer I can come up with is
<em>a valid email address is one that gets delivered to its destination</em>.</p>
<p>So, Postfix.  If you ever need a taste of purgatory, take some time to browse through
the source code, a terrifying mix of old-school C and Perl.  I once needed to create
a utility to monitor the state of a Postfix DEFERRED queue, and found it was vastly
easier to write my own queue parser in Python than understand the source to the existing
<code class="code">
qshape</code>
 utility.  Whoever wrote that clearly has an aversion to variable names
that are more than one character long.</p>
<p>Actually configuring a functional Postfix system requires commiting yourself to a long
pilgrimage across the net, picking up scattered bits of wisdom from the hardy travellers
who have passed this way before, and recorded their insights in ancient forgotten blog
posts and wiki pages.</p>
<p>Documents such as <a class="reference external" href="http://www.howtoforge.com/virtual-users-domains-postfix-courier-mysql-squirrelmail-ubuntu-10.04">http://www.howtoforge.com/virtual-users-domains-postfix-courier-mysql-squirrelmail-ubuntu-10.04</a>
include gems like <em>'this howto is meant as a practical guide; it does not cover the
theoretical backgrounds'</em>.</p>
<p>You have been warned, it seems to be saying.  Configuring this system really requires at
the very least a Masters degree in Advanced Email Hackery.</p>
<a class="reference external image-reference" href="http://www.linuxjournal.com/article/9454"><img alt="postfix flowchart" src="images/postfix_flowchart.jpg" /></a>
<p>That image is from this <a class="reference external" href="http://www.linuxjournal.com/article/9454">article</a> at Linux Journal, which is actually
a pretty good and comprehensive introduction to the architecture of Postfix</p>
<p>The <em>key</em> insight that everything else hangs on is that Postfix is <em>not</em> a program.  Postfix is a large
<em>collection</em> of programs: some of which interact with the user, and a large number which run in the
background and perform all the various tasks of gathering, processing and delivering email.</p>
<p>These programs, together with a rather complex set of folders under <code class="code">
/var/spool/postfix</code>
 that store messages as they work their way through
the system, and another set of rather complex configuration files under <code class="code">
/etc/postfix</code>
, are what comprises the
complete mail delivery system.</p>
<p>To add to the fun, many postfix configuration settings can be stored in MySQL, and it's possible to run multiple postfix instances in
parallel with each other.</p>
<div class="highlight"><pre>$ pstree -a

├─master
│   ├─anvil -l -t unix -u -c
│   ├─pickup -l -t unix -u -c
│   ├─qmgr -l -t unix -u
│   ├─smtpd -n smtp -t inet -u -c -o <span class="nv">stress</span><span class="o">=</span> -s 2
│   ├─smtpd -n smtp -t inet -u -c -o <span class="nv">stress</span><span class="o">=</span> -s 2
│   └─tlsmgr -l -t unix -u -c
├─master
│   ├─anvil -l -t unix -u -c
│   ├─pickup -l -t unix -u -c
│   ├─qmgr -l -t unix -u
│   ├─smtpd -n smtp -t inet -u -c -o <span class="nv">stress</span><span class="o">=</span>
│   └─smtpd -n smtp -t inet -u -c -o <span class="nv">stress</span><span class="o">=</span>
├─master
│   ├─anvil -l -t unix -u -c
│   ├─pickup -l -t unix -u -c
│   ├─qmgr -l -t unix -u
│   ├─smtpd -n smtp -t inet -u -c -o <span class="nv">stress</span><span class="o">=</span>
│   └─smtpd -n smtp -t inet -u -c -o <span class="nv">stress</span><span class="o">=</span>
├─master
│   ├─anvil -l -t unix -u -c
│   ├─pickup -l -t unix -u -c
│   ├─qmgr -l -t unix -u
│   ├─smtpd -n smtp -t inet -u -c -o <span class="nv">stress</span><span class="o">=</span>
│   └─smtpd -n smtp -t inet -u -c -o <span class="nv">stress</span><span class="o">=</span>
├─master
│   ├─anvil -l -t unix -u -c
│   ├─pickup -l -t unix -u -c
│   ├─qmgr -l -t unix -u
│   ├─smtpd -n smtp -t inet -u -c -o <span class="nv">stress</span><span class="o">=</span>
│   └─smtpd -n smtp -t inet -u -c -o <span class="nv">stress</span><span class="o">=</span>
</pre></div>
<p>That's a lot of processes....</p>
<p>And yet, despite this, Postfix seems to be about the best there is.  Over the last
few years I've built and maintained a massively parallel mail delivery, management
and monitoring system on top of Postfix that, at the last count, had successfully
delivered almost 10 million messages for clients of <a class="reference external" href="http://nooro.com">Nooro Online Research</a>.</p>

                    
                </div>  
                
                
            </article>
            <hr/>
            <article>
                <h2><a href="/postgres-json-aggregation.html">Postgres JSON Aggregation</a></h2>
                
                
                <div class="entry-content">

                    <p>I've been using the new JSON functionality in Postgres a lot recently:
I'm fond of saying that Postgresql is the best NoSQL database available
today. I'm quite serious about this: having used key-value and JSON
stores such as CouchDB in the past, it's amazing to me how the Postgres
developers have managed to marry the best of traditional relational
technology with the flexibility of schema-free JSON documents.</p>
<p>As of version 9.3, postgres allows you to create JSON column types, and
provides a number of functions to access and iterate through the data
stored in them.</p>
<p>This week I discovered another hidden gem - <code class="code">
json_agg()</code>
. This
function lets you take the results from an aggregation operation and
convert them into a JSON block - very helpful if you're then going to
work with the returned data in a language like Python</p>
<p>To demonstrate this, we'll first set up some simple tables.</p>
<div class="highlight"><pre><span class="o">%</span><span class="n">load_ext</span> <span class="n">sql</span>
<span class="o">%</span><span class="n">config</span> <span class="n">SqlMagic</span><span class="o">.</span><span class="n">feedback</span><span class="o">=</span><span class="bp">False</span>
</pre></div>
<div class="highlight"><pre><span class="o">%%</span><span class="n">sql</span>
<span class="n">postgresql</span><span class="p">:</span><span class="o">//</span><span class="n">testuser</span><span class="p">:</span><span class="n">password</span><span class="nd">@localhost</span><span class="o">/</span><span class="n">test</span>
</pre></div>
<pre class="literal-block">
u'Connected: <a class="reference external" href="mailto:testuser&#64;test">testuser&#64;test</a>'
</pre>
<div class="highlight"><pre><span class="o">%%</span><span class="n">sql</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">IF</span> <span class="n">NOT</span> <span class="n">EXISTS</span> <span class="n">person</span> <span class="p">(</span>
    <span class="n">name</span> <span class="n">text</span> <span class="n">primary</span> <span class="n">key</span>
<span class="p">);</span>

<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">person</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="n">VALUES</span>
<span class="p">(</span><span class="s1">&#39;emily&#39;</span><span class="p">),(</span><span class="s1">&#39;arthur&#39;</span><span class="p">),(</span><span class="s1">&#39;nicki&#39;</span><span class="p">),(</span><span class="s1">&#39;oliver&#39;</span><span class="p">)</span>
<span class="p">;</span>
</pre></div>
<pre class="literal-block">
[]
</pre>
<p>We can query this in the usual way:</p>
<div class="highlight"><pre><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">person</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered">
    <tr>
        <th>name</th>
    </tr>
    <tr>
        <td>emily</td>
    </tr>
    <tr>
        <td>arthur</td>
    </tr>
    <tr>
        <td>nicki</td>
    </tr>
    <tr>
        <td>oliver</td>
    </tr>
</table><p>But we can also use <code class="code">
json_agg()</code>
</p>
<div class="highlight"><pre><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">json_agg</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">person</span>
</pre></div>
<table class="table table-bordered">
    <tr>
        <th>json_agg</th>
    </tr>
    <tr>
        <td>[u'emily', u'arthur', u'nicki', u'oliver']</td>
    </tr>
</table><p>Which gives us a single object to work with. So far, this isn't
particularly helpful, but it becomes very useful when we start doing
<code class="code">
JOINS</code>
</p>
<div class="highlight"><pre><span class="o">%%</span><span class="n">sql</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">IF</span> <span class="n">NOT</span> <span class="n">EXISTS</span> <span class="n">action</span><span class="p">(</span>
    <span class="nb">id</span> <span class="n">serial</span> <span class="n">primary</span> <span class="n">key</span><span class="p">,</span>
    <span class="n">created</span> <span class="n">timestamp</span> <span class="k">with</span> <span class="n">time</span> <span class="n">zone</span> <span class="n">default</span> <span class="n">now</span><span class="p">(),</span>
    <span class="n">person_name</span> <span class="n">text</span> <span class="n">references</span> <span class="n">person</span><span class="p">,</span>
    <span class="nb">type</span> <span class="n">text</span> <span class="ow">not</span> <span class="n">null</span>
<span class="p">);</span>

<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;emily&#39;</span><span class="p">,</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;emily&#39;</span><span class="p">,</span><span class="s1">&#39;pageview&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;arthur&#39;</span><span class="p">,</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;emily&#39;</span><span class="p">,</span><span class="s1">&#39;logout&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;nicki&#39;</span><span class="p">,</span><span class="s1">&#39;password_change&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;nicki&#39;</span><span class="p">,</span><span class="s1">&#39;createpost&#39;</span><span class="p">);</span>
</pre></div>
<pre class="literal-block">
[]
</pre>
<p>If we want to ask Postgres to give us every user and every action
they've performed, we <em>could</em> do it this way:</p>
<div class="highlight"><pre><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  <span class="n">action</span><span class="o">.</span><span class="n">type</span> <span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">created</span> <span class="n">FROM</span> <span class="n">action</span> <span class="n">JOIN</span> <span class="n">person</span> <span class="n">ON</span> <span class="n">action</span><span class="o">.</span><span class="n">person_name</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
<table class="table table-bordered">
    <tr>
        <th>name</th>
        <th>type</th>
        <th>created</th>
    </tr>
    <tr>
        <td>emily</td>
        <td>login</td>
        <td>2014-11-08 17:45:05.963569-05:00</td>
    </tr>
    <tr>
        <td>emily</td>
        <td>pageview</td>
        <td>2014-11-08 17:45:05.964663-05:00</td>
    </tr>
    <tr>
        <td>arthur</td>
        <td>login</td>
        <td>2014-11-08 17:45:05.965214-05:00</td>
    </tr>
    <tr>
        <td>emily</td>
        <td>logout</td>
        <td>2014-11-08 17:45:05.965741-05:00</td>
    </tr>
    <tr>
        <td>nicki</td>
        <td>password_change</td>
        <td>2014-11-08 17:45:05.966274-05:00</td>
    </tr>
    <tr>
        <td>nicki</td>
        <td>createpost</td>
        <td>2014-11-08 17:45:05.966824-05:00</td>
    </tr>
</table><p>But then iterating through this recordset is a pain - I can't easily
construct a nested for loop to iterate through each person and then
through each action.</p>
<p>Enter <code class="code">
json_agg()</code>
</p>
<div class="highlight"><pre><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  <span class="n">json_agg</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">action</span> <span class="n">JOIN</span> <span class="n">person</span> <span class="n">ON</span> <span class="n">action</span><span class="o">.</span><span class="n">person_name</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
<table class="table table-bordered">
    <tr>
        <th>name</th>
        <th>json_agg</th>
    </tr>
    <tr>
        <td>arthur</td>
        <td>[{u'person_name': u'arthur', u'type': u'login', u'id': 3, u'created': u'2014-11-08 17:45:05.965214-05'}]</td>
    </tr>
    <tr>
        <td>emily</td>
        <td>[{u'person_name': u'emily', u'type': u'login', u'id': 1, u'created': u'2014-11-08 17:45:05.963569-05'}, {u'person_name': u'emily', u'type': u'pageview', u'id': 2, u'created': u'2014-11-08 17:45:05.964663-05'}, {u'person_name': u'emily', u'type': u'logout', u'id': 4, u'created': u'2014-11-08 17:45:05.965741-05'}]</td>
    </tr>
    <tr>
        <td>nicki</td>
        <td>[{u'person_name': u'nicki', u'type': u'password_change', u'id': 5, u'created': u'2014-11-08 17:45:05.966274-05'}, {u'person_name': u'nicki', u'type': u'createpost', u'id': 6, u'created': u'2014-11-08 17:45:05.966824-05'}]</td>
    </tr>
</table><p>Which becomes much more usable in Python:</p>
<div class="highlight"><pre><span class="n">people</span> <span class="o">=</span> <span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  <span class="n">json_agg</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">action</span> <span class="n">JOIN</span> <span class="n">person</span> <span class="n">ON</span> <span class="n">action</span><span class="o">.</span><span class="n">person_name</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
<div class="highlight"><pre><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">actions</span> <span class="ow">in</span> <span class="n">people</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">name</span>
</pre></div>
<pre class="literal-block">
arthur
emily
nicki
</pre>
<div class="highlight"><pre><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">actions</span> <span class="ow">in</span> <span class="n">people</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">name</span>
    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">action</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
</pre></div>
<pre class="literal-block">
arthur
    login
emily
    login
    pageview
    logout
nicki
    password_change
    createpost
</pre>
<p>So now we've managed to easily convert relational Postgres data into a
hierarchical Python data structure. From here we can easily continue to
XML, JSON, HTML or whatever document type suits your need.</p>

                    
                </div>  
                
                
            </article>
            <hr/>

        <ul class="pagination">
                <li class="prev"><a href="/index.html">&laquo;</a>
                </li>
                    <li class=""><a
                            href="/index.html">1</a></li>
                    <li class="active"><a
                            href="/index2.html">2</a></li>
                    <li class=""><a
                            href="/index3.html">3</a></li>
                <li class="next"><a
                        href="/index3.html">&raquo;</a></li>
        </ul>
        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://twitter.com/trvrm"><i class="fa fa-twitter-square fa-lg"></i> twitter</a></li>
              </ul>
            </li>





    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 trvrm
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>


</body>
</html>