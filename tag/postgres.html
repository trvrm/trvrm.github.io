<!DOCTYPE html>
<html lang="en">
<head>
        <link href="/images/favicon.png" rel="icon">
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
        
        <title>trvrm.github.io</title>
            <link rel="stylesheet" type="text/css" href="/theme/css/flatly.min.css" />
        
        <link rel="stylesheet" type="text/css" href="/theme/css/style.css" />
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" />

        <link href="/theme/css/pygments/tango.css" rel="stylesheet">
        
</head>

<body>
    <section class="hero is-primary">
    <!-- Hero header: will stick at the top -->
    <div class="hero-head">
        <nav class="navbar  ">
            <div class="navbar-menu is-active">
                <div class="navbar-end">
                    <a class="navbar-item" href="https://twitter.com/trvrm">
                        <span class="icon"> <i class="fa fa-twitter"></i> </span>
                        twitter
                    </a>
                    <a class="navbar-item" href="https://github.com/trvrm">
                        <span class="icon"> <i class="fa fa-github"></i> </span>
                        github
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Hero content: will be in the middle -->
     <div class="hero-body">
            
             
             <div class="container has-text-centered">
               <p class="title is-1">trvrm.github.io</p>
               
    <h2>Articles tagged Postgres</h2>
             </div>
     </div>
     <div class="hero-foot">
         <nav class="navbar  ">
             
            <div class="navbar-brand is-active">
                <a href="/" class="navbar-item" >
                    trvrm.github.io
                </a>
            </div>
            <div class="navbar-menu is-active">
               <div class="navbar-start">
                   
                           <a class="navbar-item  " href="/category/database.html">Database</a>
                           <a class="navbar-item  " href="/category/software.html">Software</a>
                           <a class="navbar-item  " href="/category/systems.html">Systems</a>
                           <a class="navbar-item  " href="/category/test.html">Test</a>
               
                
               </div>
               
             </div>
           
         </nav>

     </div>
  </section>
  
  
  
  


  



    <section class="section">
        
            
            <p class="title is-3">
                <a href="/using-sqlalchemy-and-postgres-functions-to-produce-json-tree-structures-from-sql-joins.html" rel="bookmark" title="Permalink to Using SQLAlchemy and Postgres functions to produce JSON tree structures from SQL joins">
                    Using SQLAlchemy and Postgres functions to produce JSON tree structures from SQL joins
                </a>
            </p>
            <p class="subtitle is-5">
                Thu 06 July 2017
            </p>
            <hr>
            <div class="content ">
                <p>More and more I'm discovering that Postgres is an amazingly powerful 'NoSQL' database, as well as the best relational database available today.</p>
<p>Since the introduction of the JSON and JSONB data types, I've been able to store both deeply nested, unstructured data AND highly relational data in the same data store.</p>
<p>But sometimes I need to be able to map between the two domains. For example, I want to perform a join across two tables and return the result as a nested tree structure, perhaps for rendering on a webpage.</p>
<p>In the past I might have aggregated the data manually in a loop, but here I demonstrate some neat tricks to get Postgres to do the heavy lifting for you.</p>
<p>I also show how to wrap these tricks in SQLAlchemy expressions.  I've started writing my SQL queries almost exclusively in SQLAlchemy, since I discovered that it allows me to think and reason about queries as collections of composable elements.  </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">func</span><span class="p">,</span><span class="n">select</span><span class="p">,</span> <span class="n">literal_column</span>
<span class="kn">import</span> <span class="nn">functools</span>

<span class="n">pandas</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.width&quot;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">pandas</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_colwidth&#39;</span><span class="p">,</span> <span class="mi">110</span><span class="p">)</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;postgresql+psycopg2://demo:password@localhost/demo&#39;</span><span class="p">)</span>
<span class="n">read</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">read_sql</span><span class="p">,</span><span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>


<h2>Turn a simple join into a nested JSON structure</h2>
<p>Consider a database consisting of two tables: <code>book</code> and <code>author</code>.</p>
<p>Each author may have written multiple books.  I want a list of authors, and for each author I want a nested list of the books they have written.</p>
<h4>Create the tables</h4>
<div class="highlight"><pre><span></span><span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    DROP TABLE IF EXISTS book;</span>
<span class="s1">    DROP TABLE IF EXISTS author;</span>
<span class="s1">    CREATE TABLE IF NOT EXISTS author(</span>
<span class="s1">        id int primary key,</span>
<span class="s1">        name text</span>
<span class="s1">    );</span>

<span class="s1">    CREATE TABLE IF NOT EXISTS book(</span>
<span class="s1">        id int primary key  ,</span>
<span class="s1">        author_id int references author,</span>
<span class="s1">        name text</span>
<span class="s1">    );</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">);</span>
</pre></div>


<h4>Use  SQLAlchemy reflection to get objects that represent each table</h4>
<div class="highlight"><pre><span></span><span class="n">metadata</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">reflect</span><span class="p">()</span>
<span class="n">tables</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span>
<span class="n">Author</span> <span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span>
<span class="n">Book</span> <span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="s1">&#39;book&#39;</span><span class="p">]</span>
</pre></div>


<h4>Populate the database</h4>
<div class="highlight"><pre><span></span><span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Author</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Douglas Adams&#39;</span><span class="p">))</span>
<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Author</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;JK Rowling&#39;</span><span class="p">))</span>
<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Author</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;JRR Tolkien&#39;</span><span class="p">))</span>

<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">author_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;The Hitchhikers Guide to the Galaxy&#39;</span><span class="p">))</span>
<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">author_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;The Restaurant at the End of the Universe&#39;</span><span class="p">))</span>
<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">author_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Life, The Universe, and Everything&#39;</span><span class="p">))</span>
<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">author_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Harry Potter and the Giant Plot Hole&#39;</span><span class="p">))</span>
<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">author_id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;The Silmarillion&#39;</span><span class="p">))</span>
<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">author_id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;The Lord of the Rings&#39;</span><span class="p">));</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">read</span><span class="p">(</span><span class="n">Author</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>
</pre></div>


<div>

<table border="1" class="dataframe table table-striped table-bordered is-striped is-bordered">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Douglas Adams</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>JK Rowling</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>JRR Tolkien</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><span class="n">read</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>
</pre></div>


<div>
<table border="1" class="dataframe table table-striped table-bordered  is-striped is-bordered">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>author_id</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4</td>
      <td>1</td>
      <td>The Hitchhikers Guide to the Galaxy</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5</td>
      <td>1</td>
      <td>The Restaurant at the End of the Universe</td>
    </tr>
    <tr>
      <th>2</th>
      <td>6</td>
      <td>1</td>
      <td>Life, The Universe, and Everything</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7</td>
      <td>2</td>
      <td>Harry Potter and the Giant Plot Hole</td>
    </tr>
    <tr>
      <th>4</th>
      <td>8</td>
      <td>3</td>
      <td>The Silmarillion</td>
    </tr>
    <tr>
      <th>5</th>
      <td>9</td>
      <td>3</td>
      <td>The Lord of the Rings</td>
    </tr>
  </tbody>
</table>
</div>

<h2>The problem: JOIN creates multiple rows per author</h2>
<div class="highlight"><pre><span></span><span class="n">read</span><span class="p">(</span>
    <span class="n">select</span><span class="p">([</span>
        <span class="n">Author</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Book</span><span class="p">)</span>
    <span class="p">])</span>
<span class="p">)</span>
</pre></div>


<div>
<table border="1" class="dataframe table table-striped table-bordered is-striped is-bordered">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>name</th>
      <th>id</th>
      <th>author_id</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Douglas Adams</td>
      <td>4</td>
      <td>1</td>
      <td>The Hitchhikers Guide to the Galaxy</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>Douglas Adams</td>
      <td>5</td>
      <td>1</td>
      <td>The Restaurant at the End of the Universe</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>Douglas Adams</td>
      <td>6</td>
      <td>1</td>
      <td>Life, The Universe, and Everything</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>JK Rowling</td>
      <td>7</td>
      <td>2</td>
      <td>Harry Potter and the Giant Plot Hole</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>JRR Tolkien</td>
      <td>8</td>
      <td>3</td>
      <td>The Silmarillion</td>
    </tr>
    <tr>
      <th>5</th>
      <td>3</td>
      <td>JRR Tolkien</td>
      <td>9</td>
      <td>3</td>
      <td>The Lord of the Rings</td>
    </tr>
  </tbody>
</table>
</div>

<h2>The goal</h2>
<p>It would be far more helpful to have a query that returns three rows - one for each author, with each author's books contained in a sub list.</p>
<p>We do that by using two powerful Postgres techniques:</p>
<ul>
<li><a href="https://www.postgresql.org/docs/9.6/static/queries-with.html">Common Table Expressions</a></li>
<li><a href="https://www.postgresql.org/docs/9.6/static/functions-aggregate.html">Aggregate functions</a>  </li>
</ul>
<p>Specifically we use the function <code>json_agg</code> to roll up a set of books into a JSON list</p>
<div class="highlight"><pre><span></span><span class="n">frame</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    WITH author_books AS (SELECT author_id, json_agg(book) FROM book GROUP BY author_id)</span>

<span class="s1">    SELECT * FROM author</span>
<span class="s1">     JOIN author_books ON author_books.author_id=author.id </span>

<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="n">frame</span>
</pre></div>


<div>
<table border="1" class="dataframe table table-striped table-bordered is-striped is-bordered">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>name</th>
      <th>author_id</th>
      <th>json_agg</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Douglas Adams</td>
      <td>1</td>
      <td>[{'id': 4, 'name': 'The Hitchhikers Guide to the Galaxy', 'author_id': 1}, {'id': 5, 'name': 'The Restarau...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>JRR Tolkien</td>
      <td>3</td>
      <td>[{'id': 8, 'name': 'The Silmarillion', 'author_id': 3}, {'id': 9, 'name': 'The Lord of the Rings', 'author...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>JK Rowling</td>
      <td>2</td>
      <td>[{'id': 7, 'name': 'Harry Potter and the Giant Plot Hole', 'author_id': 2}]</td>
    </tr>
  </tbody>
</table>
</div>

<p>And because we're using Pandas dataframes, we even have a convenience function to turn this directly into a nested Python dictionary:</p>
<div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>[{&#39;author_id&#39;: 1,
  &#39;id&#39;: 1,
  &#39;json_agg&#39;: [{&#39;author_id&#39;: 1,
    &#39;id&#39;: 4,
    &#39;name&#39;: &#39;The Hitchhikers Guide to the Galaxy&#39;},
   {&#39;author_id&#39;: 1,
    &#39;id&#39;: 5,
    &#39;name&#39;: &#39;The Restaurant at the End of the Universe&#39;},
   {&#39;author_id&#39;: 1, &#39;id&#39;: 6, &#39;name&#39;: &#39;Life, The Universe, and Everything&#39;}],
  &#39;name&#39;: &#39;Douglas Adams&#39;},
 {&#39;author_id&#39;: 3,
  &#39;id&#39;: 3,
  &#39;json_agg&#39;: [{&#39;author_id&#39;: 3, &#39;id&#39;: 8, &#39;name&#39;: &#39;The Silmarillion&#39;},
   {&#39;author_id&#39;: 3, &#39;id&#39;: 9, &#39;name&#39;: &#39;The Lord of the Rings&#39;}],
  &#39;name&#39;: &#39;JRR Tolkien&#39;},
 {&#39;author_id&#39;: 2,
  &#39;id&#39;: 2,
  &#39;json_agg&#39;: [{&#39;author_id&#39;: 2,
    &#39;id&#39;: 7,
    &#39;name&#39;: &#39;Harry Potter and the Giant Plot Hole&#39;}],
  &#39;name&#39;: &#39;JK Rowling&#39;}]
</pre></div>


<p>So now we have our data in a form which would be very easy to use in the templating language of your choice when building a web application.</p>
<h2>Ok, but can I do that in SQLAlchemy?</h2>
<p>I'm glad you asked.  First I define a little helper function to represent the underlying <code>json_agg</code> function.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">json_agg</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">json_agg</span><span class="p">(</span><span class="n">literal_column</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="o">+</span> <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span><span class="p">))</span>
</pre></div>


<p>Then I create my CTE:</p>
<div class="highlight"><pre><span></span><span class="n">AuthorBooks</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">select</span><span class="p">([</span>
        <span class="n">Book</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">author_id</span><span class="p">,</span>
        <span class="n">json_agg</span><span class="p">(</span><span class="n">Book</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;books&#39;</span><span class="p">)</span>
    <span class="p">])</span>
    <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">Book</span><span class="p">)</span>
    <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">author_id</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">cte</span><span class="p">(</span><span class="s1">&#39;author_books&#39;</span><span class="p">)</span>
</pre></div>


<p>And finally I use my CTE exactly as if it were a real table:</p>
<div class="highlight"><pre><span></span><span class="n">query</span><span class="o">=</span><span class="p">(</span>
    <span class="n">select</span><span class="p">([</span>
        <span class="n">Author</span><span class="p">,</span>
        <span class="n">AuthorBooks</span>
    <span class="p">])</span>
    <span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
        <span class="n">Author</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AuthorBooks</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">=</span><span class="n">read</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">frame</span>
</pre></div>


<div>
<table border="1" class="dataframe table table-striped table-bordered  is-striped is-bordered">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>name</th>
      <th>author_id</th>
      <th>books</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Douglas Adams</td>
      <td>1</td>
      <td>[{'id': 4, 'name': 'The Hitchhikers Guide to the Galaxy', 'author_id': 1}, {'id': 5, 'name': 'The Restarau...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>JRR Tolkien</td>
      <td>3</td>
      <td>[{'id': 8, 'name': 'The Silmarillion', 'author_id': 3}, {'id': 9, 'name': 'The Lord of the Rings', 'author...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>JK Rowling</td>
      <td>2</td>
      <td>[{'id': 7, 'name': 'Harry Potter and the Giant Plot Hole', 'author_id': 2}]</td>
    </tr>
  </tbody>
</table>
</div>

<p>And as before we can turn this into a nested Python data structure</p>
<div class="highlight"><pre><span></span><span class="n">authors</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
<span class="n">authors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span></span>&#39;Douglas Adams&#39;
</pre></div>


<div class="highlight"><pre><span></span><span class="n">authors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;books&#39;</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span></span>[{&#39;author_id&#39;: 1, &#39;id&#39;: 4, &#39;name&#39;: &#39;The Hitchhikers Guide to the Galaxy&#39;},
 {&#39;author_id&#39;: 1,
  &#39;id&#39;: 5,
  &#39;name&#39;: &#39;The Restaurant at the End of the Universe&#39;},
 {&#39;author_id&#39;: 1, &#39;id&#39;: 6, &#39;name&#39;: &#39;Life, The Universe, and Everything&#39;}]
</pre></div>


<h1>What about many-to-many joins?</h1>
<p>Let's consider a slightly more complex example, that of 'users' and 'groups'.</p>
<ul>
<li>Users can belong to many groups</li>
<li>Groups can contain many users.</li>
</ul>
<p>(As an extra bit of fun, both <code>user</code> and <code>group</code> are reserved keywords in Postgres, so we have to be careful with our quoting to make this work)</p>
<div class="highlight"><pre><span></span><span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    DROP TABLE IF EXISTS &quot;user_to_group&quot;;</span>
<span class="s1">    DROP TABLE IF EXISTS &quot;group&quot;;</span>
<span class="s1">    DROP TABLE IF EXISTS &quot;user&quot;;</span>


<span class="s1">    CREATE TABLE IF NOT EXISTS &quot;group&quot;(</span>
<span class="s1">        id int primary key,</span>
<span class="s1">        name text</span>
<span class="s1">    );</span>
<span class="s1">    CREATE TABLE IF NOT EXISTS &quot;user&quot;(</span>
<span class="s1">        id int primary key,</span>
<span class="s1">        name text</span>
<span class="s1">    );</span>
<span class="s1">    CREATE TABLE IF NOT EXISTS &quot;user_to_group&quot;(</span>
<span class="s1">        group_id int references &quot;group&quot;,</span>
<span class="s1">        user_id int references &quot;user&quot;</span>
<span class="s1">        );</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">);</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">metadata</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">reflect</span><span class="p">()</span>
<span class="n">tables</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span>

<span class="n">User</span>        <span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
<span class="n">Group</span>       <span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
<span class="n">UserToGroup</span> <span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="s1">&#39;user_to_group&#39;</span><span class="p">]</span>
</pre></div>


<h2>Populate the data</h2>
<p>We'll create three groups and five users, some of whom may be in more than one group</p>
<div class="highlight"><pre><span></span><span class="n">inserts</span><span class="o">=</span><span class="p">[</span>
    <span class="n">Group</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Hobbits&#39;</span><span class="p">),</span>
    <span class="n">Group</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Wizards&#39;</span><span class="p">),</span>
    <span class="n">Group</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;The Fellowship&#39;</span><span class="p">),</span>

    <span class="n">User</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Frodo&#39;</span><span class="p">),</span>
    <span class="n">User</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Gandalf&#39;</span><span class="p">),</span>
    <span class="n">User</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Legolas&#39;</span><span class="p">),</span>
    <span class="n">User</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Pippin&#39;</span><span class="p">),</span>
    <span class="n">User</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Saruman&#39;</span><span class="p">),</span>


    <span class="n">UserToGroup</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">group_id</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">UserToGroup</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">group_id</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">UserToGroup</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">group_id</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">UserToGroup</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">group_id</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>


    <span class="n">UserToGroup</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">group_id</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">UserToGroup</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">group_id</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">UserToGroup</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">group_id</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">UserToGroup</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">group_id</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inserts</span><span class="p">:</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>


<h4>A simple join gives us all our data, but in a form that may be clunky to work with.</h4>
<div class="highlight"><pre><span></span><span class="n">read</span><span class="p">(</span><span class="n">Group</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UserToGroup</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>
</pre></div>


<div>
<table border="1" class="dataframe table table-striped table-bordered  is-striped is-bordered">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>name</th>
      <th>group_id</th>
      <th>user_id</th>
      <th>id</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Hobbits</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>Frodo</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>Hobbits</td>
      <td>1</td>
      <td>4</td>
      <td>4</td>
      <td>Pippin</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>Wizards</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>Gandalf</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>Wizards</td>
      <td>2</td>
      <td>5</td>
      <td>5</td>
      <td>Saruman</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>The Fellowship</td>
      <td>3</td>
      <td>1</td>
      <td>1</td>
      <td>Frodo</td>
    </tr>
    <tr>
      <th>5</th>
      <td>3</td>
      <td>The Fellowship</td>
      <td>3</td>
      <td>2</td>
      <td>2</td>
      <td>Gandalf</td>
    </tr>
    <tr>
      <th>6</th>
      <td>3</td>
      <td>The Fellowship</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>Legolas</td>
    </tr>
    <tr>
      <th>7</th>
      <td>3</td>
      <td>The Fellowship</td>
      <td>3</td>
      <td>4</td>
      <td>4</td>
      <td>Pippin</td>
    </tr>
  </tbody>
</table>
</div>

<h3>Instead, let's create two queries</h3>
<ul>
<li>a list of users, each with a list of their groups</li>
<li>a list of groups, each with a list of their users</li>
</ul>
<p>In SQL, it looks like this:</p>
<div class="highlight"><pre><span></span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    WITH user_groups AS (</span>
<span class="s1">        SELECT user_id, json_agg(&quot;group&quot;) AS groups</span>
<span class="s1">          FROM user_to_group </span>
<span class="s1">          JOIN &quot;group&quot; </span>
<span class="s1">            ON user_to_group.group_id=&quot;group&quot;.id</span>
<span class="s1">        GROUP BY user_id  </span>

<span class="s1">    )</span>

<span class="s1">    SELECT id,name,groups FROM &quot;user&quot;</span>
<span class="s1">     JOIN user_groups on &quot;user&quot;.id = user_groups.user_id</span>

<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>


<div>
<table border="1" class="dataframe table table-striped table-bordered is-striped is-bordered">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>name</th>
      <th>groups</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4</td>
      <td>Pippin</td>
      <td>[{'id': 1, 'name': 'Hobbits'}, {'id': 3, 'name': 'The Fellowship'}]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>Frodo</td>
      <td>[{'id': 1, 'name': 'Hobbits'}, {'id': 3, 'name': 'The Fellowship'}]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5</td>
      <td>Saruman</td>
      <td>[{'id': 2, 'name': 'Wizards'}]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>Legolas</td>
      <td>[{'id': 3, 'name': 'The Fellowship'}]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2</td>
      <td>Gandalf</td>
      <td>[{'id': 2, 'name': 'Wizards'}, {'id': 3, 'name': 'The Fellowship'}]</td>
    </tr>
  </tbody>
</table>
</div>

<p>But we want to use SQLAlchemy, so again we create CTE objects to help us</p>
<h2>A list of users showing the groups they belong to</h2>
<div class="highlight"><pre><span></span><span class="n">UserGroups</span><span class="o">=</span><span class="p">(</span>
    <span class="n">select</span><span class="p">([</span>
        <span class="n">UserToGroup</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">json_agg</span><span class="p">(</span><span class="n">Group</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">)</span>
    <span class="p">])</span>
    <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">Group</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UserToGroup</span><span class="p">))</span>
    <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">UserToGroup</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">cte</span><span class="p">(</span><span class="s1">&#39;user_groups&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">query</span><span class="o">=</span><span class="p">(</span>
    <span class="n">select</span><span class="p">([</span>
        <span class="n">User</span><span class="p">,</span>
        <span class="n">UserGroups</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">groups</span>
    <span class="p">])</span>
    <span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
        <span class="n">User</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UserGroups</span><span class="p">,</span><span class="n">User</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">UserGroups</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">read</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>


<div>
<table border="1" class="dataframe table table-striped table-bordered  is-striped is-bordered">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>name</th>
      <th>groups</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4</td>
      <td>Pippin</td>
      <td>[{'id': 1, 'name': 'Hobbits'}, {'id': 3, 'name': 'The Fellowship'}]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>Frodo</td>
      <td>[{'id': 1, 'name': 'Hobbits'}, {'id': 3, 'name': 'The Fellowship'}]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5</td>
      <td>Saruman</td>
      <td>[{'id': 2, 'name': 'Wizards'}]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>Legolas</td>
      <td>[{'id': 3, 'name': 'The Fellowship'}]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2</td>
      <td>Gandalf</td>
      <td>[{'id': 2, 'name': 'Wizards'}, {'id': 3, 'name': 'The Fellowship'}]</td>
    </tr>
  </tbody>
</table>
</div>

<h2>A list of groups showing the users that are members of them</h2>
<div class="highlight"><pre><span></span><span class="n">GroupUsers</span><span class="o">=</span><span class="p">(</span>
    <span class="n">select</span><span class="p">([</span>
        <span class="n">UserToGroup</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">group_id</span><span class="p">,</span>
        <span class="n">json_agg</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">)</span>
    <span class="p">])</span>
    <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UserToGroup</span><span class="p">))</span>
    <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">UserToGroup</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">group_id</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">cte</span><span class="p">(</span><span class="s1">&#39;group_users&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">query</span><span class="o">=</span><span class="p">(</span>
    <span class="n">select</span><span class="p">([</span>
        <span class="n">Group</span><span class="p">,</span>
        <span class="n">GroupUsers</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">users</span>
    <span class="p">])</span>
    <span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
        <span class="n">Group</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GroupUsers</span><span class="p">,</span><span class="n">Group</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">GroupUsers</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">group_id</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">read</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>


<div>
<table border="1" class="dataframe table table-striped table-bordered is-striped is-bordered">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>name</th>
      <th>users</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Hobbits</td>
      <td>[{'id': 1, 'name': 'Frodo'}, {'id': 4, 'name': 'Pippin'}]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>The Fellowship</td>
      <td>[{'id': 1, 'name': 'Frodo'}, {'id': 2, 'name': 'Gandalf'}, {'id': 3, 'name': 'Legolas'}, {'id': 4, 'name':...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>Wizards</td>
      <td>[{'id': 2, 'name': 'Gandalf'}, {'id': 5, 'name': 'Saruman'}]</td>
    </tr>
  </tbody>
</table>
</div>

<h2>And again, we can always convert this to a nested Python data structure</h2>
<div class="highlight"><pre><span></span><span class="n">read</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>[{&#39;id&#39;: 1,
  &#39;name&#39;: &#39;Hobbits&#39;,
  &#39;users&#39;: [{&#39;id&#39;: 1, &#39;name&#39;: &#39;Frodo&#39;}, {&#39;id&#39;: 4, &#39;name&#39;: &#39;Pippin&#39;}]},
 {&#39;id&#39;: 3,
  &#39;name&#39;: &#39;The Fellowship&#39;,
  &#39;users&#39;: [{&#39;id&#39;: 1, &#39;name&#39;: &#39;Frodo&#39;},
   {&#39;id&#39;: 2, &#39;name&#39;: &#39;Gandalf&#39;},
   {&#39;id&#39;: 3, &#39;name&#39;: &#39;Legolas&#39;},
   {&#39;id&#39;: 4, &#39;name&#39;: &#39;Pippin&#39;}]},
 {&#39;id&#39;: 2,
  &#39;name&#39;: &#39;Wizards&#39;,
  &#39;users&#39;: [{&#39;id&#39;: 2, &#39;name&#39;: &#39;Gandalf&#39;}, {&#39;id&#39;: 5, &#39;name&#39;: &#39;Saruman&#39;}]}]
</pre></div>


<h2>Conclusion</h2>
<p>I demonstrate how to use <code>WITH</code> statements (Common Table Expressions), the <code>json_agg</code> function and SQLAlchemy to quickly convert complex SQL joins into nested Python data structures. </p>
<p>Using techniques like the ones presented here, Postgres can act as a powerful relational data store that can still provide applications with data in helpful forms, such as nested dictionaries and lists.</p>

            </div>
        
    </section>
    <section class="section">
        
            
            <p class="title is-3">
                <a href="/bulk-psycopg2-inserts.html" rel="bookmark" title="Permalink to Efficient Postgres Bulk Inserts using Psycopg2 and Unnest">
                    Efficient Postgres Bulk Inserts using Psycopg2 and Unnest
                </a>
            </p>
            <p class="subtitle is-5">
                Thu 22 October 2015
            </p>
            <hr>
            <div class="content ">
                <p>One of the biggest challenges I face maintaining large Postgres systems
is getting data <em>into</em> them in an efficient manner. Postgres is very,
very good at maintaining, organising, querying and retrieving data, but
inserts themselves can be quite slow.</p>
<p>Various stackoverflow questions suggest using things like <code class="code">
COPY</code>
, but
that assumes your application has direct write access to the machine
that is running Postgres, and I work very hard to maintain strict
seperation of functionality between software components.</p>
<p>So I've been looking for a faster way of inserting, say, 100,000 rows
into the database across the wire, and what follows is by far the most
efficient technique I've found so far.</p>
<div class="section" id="set-some-visualisation-options">
<h2>Set some visualisation options</h2>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
</pre></div>
</div>
<div class="section" id="import-the-libraries-we-ll-be-using">
<h2>Import the libraries we'll be using</h2>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array_split</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">from</span> <span class="nn">psycopg2.extras</span> <span class="kn">import</span> <span class="n">Json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
</pre></div>
</div>
<div class="section" id="a-context-manager-for-timing-operations">
<h2>A context manager for timing operations.</h2>
<div class="highlight"><pre><span></span><span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">timer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;duration&quot;</span><span class="p">):</span>
    <span class="s1">&#39;Utility function for timing execution&#39;</span>
    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">duration</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0}: {1} second(s)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">duration</span><span class="p">))</span>
</pre></div>
</div>
<div class="section" id="test-setup">
<h2>Test setup</h2>
<p>My tests are based on creating a fairly simple table and timing how long
it takes to perform inserts on it via several different methods. The
table has a couple of default columns, a text column, and an HSTORE
column.</p>
<div class="highlight"><pre><span></span><span class="n">SETUP_SQL</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    DROP TABLE IF EXISTS upload_time_test;</span>

<span class="s2">    CREATE TABLE upload_time_test(</span>
<span class="s2">        uuid uuid primary key default uuid_generate_v4(),</span>
<span class="s2">        created timestamp with time zone not null default now(),</span>
<span class="s2">        text text not null,</span>
<span class="s2">        properties hstore not null default &#39;&#39;::hstore</span>
<span class="s2">    );</span>

<span class="s2">    GRANT ALL ON upload_time_test TO test;</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
<p>This is the SQL we'll use for inserting a single row into the database
table:</p>
<div class="highlight"><pre><span></span><span class="n">SINGLE_INSERT</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    INSERT INTO upload_time_test(text,properties)</span>
<span class="s2">         VALUES (</span><span class="si">%(text)s</span><span class="s2">, </span><span class="si">%(properties)s</span><span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
<p>Credentials for connecting to my local test database</p>
<div class="highlight"><pre><span></span><span class="n">HOST</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span>
<span class="n">DATABASE</span><span class="o">=</span><span class="s1">&#39;test&#39;</span>
<span class="n">USER</span><span class="o">=</span><span class="s1">&#39;test&#39;</span>
<span class="n">PASSWORD</span><span class="o">=</span><span class="s1">&#39;password&#39;</span>
</pre></div>
<p>Then we define a couple of simple wrappers around <code class="code">
psycopg2</code>
</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">connect</span><span class="p">():</span>
    <span class="n">connection</span><span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">HOST</span><span class="p">,</span><span class="n">database</span><span class="o">=</span><span class="n">DATABASE</span><span class="p">,</span><span class="n">user</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span><span class="n">password</span><span class="o">=</span><span class="n">PASSWORD</span><span class="p">)</span>
    <span class="n">psycopg2</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">register_hstore</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">connection</span>
<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
    <span class="k">with</span> <span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
</pre></div>
<p>This is the heart of my tests. The <code class="code">
Tester</code>
 class destroys and
re-creates the sample table every time we instantiate it.</p>
<p>It provides three different functions for inserting database rows, each
based on a different technique.</p>
<ul class="simple">
<li><code class="code">
slowInsert()</code>
 is the slowest, because it creates a new database
connection for each row</li>
<li><code class="code">
insert()</code>
 is the approach I had been using up till now. It creates
one connection, and re-uses it for each insertion. This is basically
what <code class="code">
executemany()</code>
 in psycopg2 is doing.</li>
<li><code class="code">
fastInsert()</code>
 is my new approach, based on using <strong>unnest()</strong> to
unroll a set of arrays passed in through psycopg2</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Tester</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">count</span><span class="p">):</span>
        <span class="n">execute</span><span class="p">(</span><span class="n">SETUP_SQL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="o">=</span><span class="n">count</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="s1">&#39;Some text&#39;</span><span class="p">,</span>
                <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span><span class="s2">&quot;value&quot;</span><span class="p">},</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">slowInsert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Creates a new connection for each insertion</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">text</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
            <span class="n">properties</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span>
            <span class="n">execute</span><span class="p">(</span><span class="n">SINGLE_INSERT</span><span class="p">,</span><span class="nb">locals</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            One connection.</span>
<span class="sd">            Multiple queries.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
                    <span class="n">properties</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SINGLE_INSERT</span><span class="p">,</span><span class="nb">locals</span><span class="p">())</span>


    <span class="k">def</span> <span class="nf">fastInsert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            One connection, one query.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            INSERT INTO upload_time_test(text,properties)</span>
<span class="s1">              SELECT unnest( </span><span class="si">%(texts)s</span><span class="s1"> ) ,</span>
<span class="s1">                     unnest( </span><span class="si">%(properties)s</span><span class="s1">)</span>

<span class="s1">        &#39;&#39;&#39;</span>

        <span class="n">texts</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
        <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
        <span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="nb">locals</span><span class="p">())</span>
</pre></div>
<p>So now we have the Tester class written, we can see how log each
approach takes to insert 1000 rows</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">runTests</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
    <span class="n">tester</span> <span class="o">=</span> <span class="n">Tester</span><span class="p">(</span><span class="n">iterations</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">timer</span><span class="p">(</span><span class="s1">&#39;slow&#39;</span><span class="p">):</span>
        <span class="n">tester</span><span class="o">.</span><span class="n">slowInsert</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">timer</span><span class="p">(</span><span class="s1">&#39;normal&#39;</span><span class="p">):</span>
        <span class="n">tester</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">timer</span><span class="p">(</span><span class="s1">&#39;fast&#39;</span><span class="p">):</span>
        <span class="n">tester</span><span class="o">.</span><span class="n">fastInsert</span><span class="p">()</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">runTests</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
<pre class="literal-block">
slow: 7.160489320755005 second(s)
normal: 0.1441025733947754 second(s)
fast: 0.042119503021240234 second(s)
</pre>
<p><strong>We notice an obvious difference between the approaches.</strong></p>
<p>Re-using the connection makes a <em>huge</em> difference. Inserts run 50 times
faster.</p>
<p>Using <code class="code">
unnest()</code>
 runs 3 times faster than that.</p>
<div class="section" id="what-about-much-bigger-data-sets">
<h3>What about much bigger data sets?</h3>
<p>Next, I wanted to know if this held true for inserting, say, 100,000
rows. I won't bother with the slowest approach, because that's clearly
unusable.</p>
<div class="highlight"><pre><span></span><span class="n">tester</span><span class="o">=</span><span class="n">Tester</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
<span class="k">with</span> <span class="n">timer</span><span class="p">(</span><span class="s1">&#39;normal&#39;</span><span class="p">):</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span>

<span class="n">tester</span><span class="o">=</span><span class="n">Tester</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
<span class="k">with</span> <span class="n">timer</span><span class="p">(</span><span class="s1">&#39;fast&#39;</span><span class="p">):</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">fastInsert</span><span class="p">()</span>
</pre></div>
<pre class="literal-block">
normal: 14.866096019744873 second(s)
fast: 3.9566986560821533 second(s)
</pre>
<p>So even over 100,000 rows we still run nearly 4 times faster using
<code class="code">
unnest</code>
</p>
</div>
<div class="section" id="further-investigation-mapping-insertion-rate-against-number-of-rows-inserted">
<h3>Further investigation - mapping insertion rate against number of rows inserted.</h3>
<p>I wanted to see the exact relationship between the rate of insertion and
the number of rows being inserted.</p>
<p>So first I wrote a couple of functions to measure the insertion rate of
our two methods:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bulkInsertRate</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">tester</span><span class="o">=</span><span class="n">Tester</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">fastInsert</span><span class="p">()</span>
    <span class="n">duration</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span>
    <span class="k">return</span> <span class="n">count</span><span class="o">/</span><span class="n">duration</span>

<span class="k">def</span> <span class="nf">normalInsertRate</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">tester</span><span class="o">=</span><span class="n">Tester</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span>
    <span class="n">duration</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span>
    <span class="k">return</span> <span class="n">count</span><span class="o">/</span><span class="n">duration</span>
</pre></div>
<p>And then we run them with a range of dataset sizes</p>
<div class="highlight"><pre><span></span><span class="n">counts</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">2000</span><span class="p">,</span><span class="mi">5000</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="mi">20000</span><span class="p">,</span><span class="mi">50000</span><span class="p">,</span><span class="mi">100000</span><span class="p">]</span>

<span class="n">rates</span><span class="o">=</span><span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;count&quot;</span><span class="p">:</span><span class="n">count</span><span class="p">,</span>
         <span class="s1">&#39;bulk&#39;</span><span class="p">:</span><span class="n">bulkInsertRate</span><span class="p">(</span><span class="n">count</span><span class="p">),</span>
        <span class="s1">&#39;normal&#39;</span><span class="p">:</span><span class="n">normalInsertRate</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

    <span class="p">}</span>
    <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counts</span>
<span class="p">]</span>
</pre></div>
<p>Finally, I use Pandas to plot the output data from these tests.</p>
<div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">=</span><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
<span class="n">frame</span>
</pre></div>
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe table table-striped table-bordered is-striped is-bordered">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>bulk</th>
      <th>normal</th>
    </tr>
    <tr>
      <th>count</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>50    </th>
      <td>  4485.694730</td>
      <td> 3867.856879</td>
    </tr>
    <tr>
      <th>100   </th>
      <td> 10159.389609</td>
      <td> 4847.897547</td>
    </tr>
    <tr>
      <th>200   </th>
      <td> 15212.186276</td>
      <td> 6057.106548</td>
    </tr>
    <tr>
      <th>500   </th>
      <td> 27340.842720</td>
      <td> 7081.049689</td>
    </tr>
    <tr>
      <th>1000  </th>
      <td> 33248.545382</td>
      <td> 7694.657609</td>
    </tr>
    <tr>
      <th>2000  </th>
      <td> 35640.695767</td>
      <td> 7070.777670</td>
    </tr>
    <tr>
      <th>5000  </th>
      <td> 41223.200473</td>
      <td> 8027.790910</td>
    </tr>
    <tr>
      <th>10000 </th>
      <td> 40948.723106</td>
      <td> 7785.005392</td>
    </tr>
    <tr>
      <th>20000 </th>
      <td> 42604.387914</td>
      <td> 7568.314015</td>
    </tr>
    <tr>
      <th>50000 </th>
      <td> 40795.233470</td>
      <td> 7291.552509</td>
    </tr>
    <tr>
      <th>100000</th>
      <td> 27014.354119</td>
      <td> 6872.935483</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight"><pre><span></span><span class="n">frame</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logx</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<pre class="literal-block">
&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fcbdecd0908&gt;
</pre>
<img alt="" src="images/bulk_psycopg2_inserts_files/bulk_psycopg2_inserts_30_1.png" />
</div>
<div class="section" id="conclusion">
<h3>Conclusion</h3>
<p>Using <code class="code">
unnest</code>
 to load multiple rows simultaneously has the following
advantages:</p>
<ul class="simple">
<li>It is significantly faster than a regular insert loop, especially
when inserting thousands of rows.</li>
<li>The benefits of using unnest() increase at least up to 50,000 rows</li>
<li>It still allows us to write (reasonably) straightforward
parameterised SQL with no string concatenation</li>
<li>When I tried this on a remote database, the improvements were even
more impressive, presumably as it reduces significantly how much data
is transferred back and forth across the network.</li>
</ul>
</div>
</div>


            </div>
        
    </section>
    <section class="section">
        
            
            <p class="title is-3">
                <a href="/postgres-json-aggregation.html" rel="bookmark" title="Permalink to Postgres JSON Aggregation">
                    Postgres JSON Aggregation
                </a>
            </p>
            <p class="subtitle is-5">
                Thu 01 January 2015
            </p>
            <hr>
            <div class="content ">
                <p>I've been using the new JSON functionality in Postgres a lot recently:
I'm fond of saying that Postgresql is the best NoSQL database available
today. I'm quite serious about this: having used key-value and JSON
stores such as CouchDB in the past, it's amazing to me how the Postgres
developers have managed to marry the best of traditional relational
technology with the flexibility of schema-free JSON documents.</p>
<p>As of version 9.3, postgres allows you to create JSON column types, and
provides a number of functions to access and iterate through the data
stored in them.</p>
<p>This week I discovered another hidden gem - <code class="code">
json_agg()</code>
. This
function lets you take the results from an aggregation operation and
convert them into a JSON block - very helpful if you're then going to
work with the returned data in a language like Python</p>
<p>To demonstrate this, we'll first set up some simple tables.</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">load_ext</span> <span class="n">sql</span>
<span class="o">%</span><span class="n">config</span> <span class="n">SqlMagic</span><span class="o">.</span><span class="n">feedback</span><span class="o">=</span><span class="bp">False</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">postgresql</span><span class="p">:</span><span class="o">//</span><span class="n">testuser</span><span class="p">:</span><span class="n">password</span><span class="nd">@localhost</span><span class="o">/</span><span class="n">test</span>
</pre></div>
<pre class="literal-block">
u'Connected: <a class="reference external" href="mailto:testuser&#64;test">testuser&#64;test</a>'
</pre>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">IF</span> <span class="n">NOT</span> <span class="n">EXISTS</span> <span class="n">person</span> <span class="p">(</span>
    <span class="n">name</span> <span class="n">text</span> <span class="n">primary</span> <span class="n">key</span>
<span class="p">);</span>

<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">person</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="n">VALUES</span>
<span class="p">(</span><span class="s1">&#39;emily&#39;</span><span class="p">),(</span><span class="s1">&#39;arthur&#39;</span><span class="p">),(</span><span class="s1">&#39;nicki&#39;</span><span class="p">),(</span><span class="s1">&#39;oliver&#39;</span><span class="p">)</span>
<span class="p">;</span>
</pre></div>
<pre class="literal-block">
[]
</pre>
<p>We can query this in the usual way:</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">person</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered  is-striped is-bordered">
    <tr>
        <th>name</th>
    </tr>
    <tr>
        <td>emily</td>
    </tr>
    <tr>
        <td>arthur</td>
    </tr>
    <tr>
        <td>nicki</td>
    </tr>
    <tr>
        <td>oliver</td>
    </tr>
</table><p>But we can also use <code class="code">
json_agg()</code>
</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">json_agg</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">person</span>
</pre></div>
<table class="table table-bordered  is-striped is-bordered">
    <tr>
        <th>json_agg</th>
    </tr>
    <tr>
        <td>[u'emily', u'arthur', u'nicki', u'oliver']</td>
    </tr>
</table><p>Which gives us a single object to work with. So far, this isn't
particularly helpful, but it becomes very useful when we start doing
<code class="code">
JOINS</code>
</p>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">IF</span> <span class="n">NOT</span> <span class="n">EXISTS</span> <span class="n">action</span><span class="p">(</span>
    <span class="nb">id</span> <span class="n">serial</span> <span class="n">primary</span> <span class="n">key</span><span class="p">,</span>
    <span class="n">created</span> <span class="n">timestamp</span> <span class="k">with</span> <span class="n">time</span> <span class="n">zone</span> <span class="n">default</span> <span class="n">now</span><span class="p">(),</span>
    <span class="n">person_name</span> <span class="n">text</span> <span class="n">references</span> <span class="n">person</span><span class="p">,</span>
    <span class="nb">type</span> <span class="n">text</span> <span class="ow">not</span> <span class="n">null</span>
<span class="p">);</span>

<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;emily&#39;</span><span class="p">,</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;emily&#39;</span><span class="p">,</span><span class="s1">&#39;pageview&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;arthur&#39;</span><span class="p">,</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;emily&#39;</span><span class="p">,</span><span class="s1">&#39;logout&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;nicki&#39;</span><span class="p">,</span><span class="s1">&#39;password_change&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;nicki&#39;</span><span class="p">,</span><span class="s1">&#39;createpost&#39;</span><span class="p">);</span>
</pre></div>
<pre class="literal-block">
[]
</pre>
<p>If we want to ask Postgres to give us every user and every action
they've performed, we <em>could</em> do it this way:</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  <span class="n">action</span><span class="o">.</span><span class="n">type</span> <span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">created</span> <span class="n">FROM</span> <span class="n">action</span> <span class="n">JOIN</span> <span class="n">person</span> <span class="n">ON</span> <span class="n">action</span><span class="o">.</span><span class="n">person_name</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
<table class="table table-bordered  is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>type</th>
        <th>created</th>
    </tr>
    <tr>
        <td>emily</td>
        <td>login</td>
        <td>2014-11-08 17:45:05.963569-05:00</td>
    </tr>
    <tr>
        <td>emily</td>
        <td>pageview</td>
        <td>2014-11-08 17:45:05.964663-05:00</td>
    </tr>
    <tr>
        <td>arthur</td>
        <td>login</td>
        <td>2014-11-08 17:45:05.965214-05:00</td>
    </tr>
    <tr>
        <td>emily</td>
        <td>logout</td>
        <td>2014-11-08 17:45:05.965741-05:00</td>
    </tr>
    <tr>
        <td>nicki</td>
        <td>password_change</td>
        <td>2014-11-08 17:45:05.966274-05:00</td>
    </tr>
    <tr>
        <td>nicki</td>
        <td>createpost</td>
        <td>2014-11-08 17:45:05.966824-05:00</td>
    </tr>
</table><p>But then iterating through this recordset is a pain - I can't easily
construct a nested for loop to iterate through each person and then
through each action.</p>
<p>Enter <code class="code">
json_agg()</code>
</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  <span class="n">json_agg</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">action</span> <span class="n">JOIN</span> <span class="n">person</span> <span class="n">ON</span> <span class="n">action</span><span class="o">.</span><span class="n">person_name</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
<table class="table table-bordered is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>json_agg</th>
    </tr>
    <tr>
        <td>arthur</td>
        <td>[{u'person_name': u'arthur', u'type': u'login', u'id': 3, u'created': u'2014-11-08 17:45:05.965214-05'}]</td>
    </tr>
    <tr>
        <td>emily</td>
        <td>[{u'person_name': u'emily', u'type': u'login', u'id': 1, u'created': u'2014-11-08 17:45:05.963569-05'}, {u'person_name': u'emily', u'type': u'pageview', u'id': 2, u'created': u'2014-11-08 17:45:05.964663-05'}, {u'person_name': u'emily', u'type': u'logout', u'id': 4, u'created': u'2014-11-08 17:45:05.965741-05'}]</td>
    </tr>
    <tr>
        <td>nicki</td>
        <td>[{u'person_name': u'nicki', u'type': u'password_change', u'id': 5, u'created': u'2014-11-08 17:45:05.966274-05'}, {u'person_name': u'nicki', u'type': u'createpost', u'id': 6, u'created': u'2014-11-08 17:45:05.966824-05'}]</td>
    </tr>
</table><p>Which becomes much more usable in Python:</p>
<div class="highlight"><pre><span></span><span class="n">people</span> <span class="o">=</span> <span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  <span class="n">json_agg</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">action</span> <span class="n">JOIN</span> <span class="n">person</span> <span class="n">ON</span> <span class="n">action</span><span class="o">.</span><span class="n">person_name</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">actions</span> <span class="ow">in</span> <span class="n">people</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">name</span>
</pre></div>
<pre class="literal-block">
arthur
emily
nicki
</pre>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">actions</span> <span class="ow">in</span> <span class="n">people</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">name</span>
    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">action</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
</pre></div>
<pre class="literal-block">
arthur
    login
emily
    login
    pageview
    logout
nicki
    password_change
    createpost
</pre>
<p>So now we've managed to easily convert relational Postgres data into a
hierarchical Python data structure. From here we can easily continue to
XML, JSON, HTML or whatever document type suits your need.</p>


            </div>
        
    </section>
    <section class="section">
        
            
            <p class="title is-3">
                <a href="/postgres-timestamps.html" rel="bookmark" title="Permalink to Postgres Timestamps">
                    Postgres Timestamps
                </a>
            </p>
            <p class="subtitle is-5">
                Thu 01 January 2015
            </p>
            <hr>
            <div class="content ">
                <p>At my company, I maintain a large distributed. data collection platform
. Pretty much every record we collect needs to be stamped with a
<code class="code">
created</code>
 field. But because the incoming data comes from sources on
various devices in multiple countries and timezones, making sure that
the timestamps are precise and meaningful can be a challenge.
<a class="reference external" href="http://www.postgresql.org/">Postgres</a> can do this very elegantly,
but can also trip you up in subtle ways.</p>
<p>Postgres has two subtly different timestamp data types: <code class="code">
TIMESTAMP</code>

and <code class="code">
TIMESTAMP WITH TIMEZONE</code>
.</p>
<p>The former stores year/month/day/hour/minutes/second/milliseconds, as
you’d expect, and the later ALSO stores a timezone offset, expressed in
hours.</p>
<p>We can switch between the two using the <code class="code">
AT TIMEZONE</code>
 syntax, but, and
here is the tricky bit the function goes BOTH WAYS, and you can easily
get confused if you don’t know what type you’re starting with.</p>
<p>Furthermore, Postgres will sometimes sneakily convert one to the other
without you asking.</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">load_ext</span> <span class="n">sql</span>
<span class="o">%</span><span class="n">config</span> <span class="n">SqlMagic</span><span class="o">.</span><span class="n">feedback</span><span class="o">=</span><span class="bp">False</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">postgresql</span><span class="p">:</span><span class="o">//</span><span class="n">testuser</span><span class="p">:</span><span class="n">password</span><span class="nd">@localhost</span><span class="o">/</span><span class="n">test</span>
</pre></div>
<pre class="literal-block">
u'Connected: <a class="reference external" href="mailto:testuser&#64;test">testuser&#64;test</a>'
</pre>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">NOW</span><span class="p">();</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>now</th>
    </tr>
    <tr>
        <td>2014-08-18 22:33:58.998549-04:00</td>
    </tr>
</table><p><code class="code">
now()</code>
 returns a <code class="code">
TIMESTAMP WITH TIME ZONE</code>
. It shows the current
<strong>local</strong> time, and the offset between that time and UTC
(<a class="reference external" href="http://time.is/UTC">http://time.is/UTC</a>)</p>
<p>But if we put the output from <code class="code">
now()</code>
 into a field that has type
<code class="code">
TIMESTAMP</code>
 we will get a silent conversion:</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">NOW</span><span class="p">()::</span> <span class="n">timestamp</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>now</th>
    </tr>
    <tr>
        <td>2014-08-18 22:33:58.998549</td>
    </tr>
</table><p>Which is <strong>not</strong> the current UTC time. We have stripped the timezone
offset right of it. However, if we <strong>explicitly</strong> do the conversion, we
get:</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">NOW</span><span class="p">()</span> <span class="n">AT</span> <span class="n">TIME</span> <span class="n">ZONE</span> <span class="s1">&#39;UTC&#39;</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>timezone</th>
    </tr>
    <tr>
        <td>2014-08-19 02:33:58.998549</td>
    </tr>
</table><p>Which <em>is</em> the current UTC time: (<a class="reference external" href="http://time.is/UTC">http://time.is/UTC</a>)</p>
<p>It's worth reviewing the <a class="reference external" href="http://www.postgresql.org/docs/9.1/static/functions-datetime.html#FUNCTIONS-DATETIME-ZONECONVERT-TABLE">Postgresql documentation on this
construct</a>
at this point.</p>
<table class="table table-bordered">
<tr><th><p>Expression</p>
</th><th><p>Return Type</p>
</th><th><p>Description</p>
</th></tr>
<tr><td><p>timestamp without time zone AT TIME ZONE zone</p>
</td><td><p>timestamp with time zone</p>
</td><td><p>Treat given time stamp without time zone as located in the specified
time zone</p>
</td></tr>
<tr><td><p>timestamp with time zone AT TIME ZONE zone</p>
</td><td><p>timestamp without time zone</p>
</td><td><p>Convert given time stamp with time zone to the new time zone, with no
time zone designation</p>
</td></tr><table class="table table-bordered table-striped is-striped is-bordered"><p>The danger here is that the <code class="code">
AT TIMEZONE</code>
 construct goes <strong>both
ways</strong>. If you don't know what type you're feeding in, you won't know
what type you're getting out. I've been bitten by this in the past;
ending up with a timestamp that is wrong by several hours because I
wasn't clear about my inputs.</p>
<p>Specifically, consider a table that looks like this:</p>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">DROP</span> <span class="n">TABLE</span> <span class="n">IF</span> <span class="n">EXISTS</span> <span class="n">test</span><span class="p">;</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">test</span><span class="p">(</span><span class="n">name</span> <span class="n">TEXT</span><span class="p">,</span> <span class="n">created</span> <span class="n">TIMESTAMP</span> <span class="n">DEFAULT</span> <span class="n">NOW</span><span class="p">());</span>
</pre></div>
<p>Which I then populate:</p>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">test</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;zaphod beeblebrox&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">test</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">created</span><span class="p">)</span> <span class="n">VALUES</span><span class="p">(</span><span class="s1">&#39;ford prefect&#39;</span><span class="p">,</span><span class="n">now</span><span class="p">()</span> <span class="n">at</span> <span class="n">time</span> <span class="n">zone</span> <span class="s1">&#39;utc&#39;</span><span class="p">);</span>
<span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">test</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>created</th>
    </tr>
    <tr>
        <td>zaphod beeblebrox</td>
        <td>2014-08-18 22:34:03.620583</td>
    </tr>
    <tr>
        <td>ford prefect</td>
        <td>2014-08-19 02:34:03.621957</td>
    </tr>
</table><p>Note that the second record contains the current UTC time, but the first
contains the current time <strong>local to the database server</strong>. This <em>seems</em>
a good idea, and tends to work fine in local testing. But when you try
to maintain a system where the database may be in one province, the data
<em>collected</em> in another, and then <em>reviewed</em> in a third, you start to
understand why this is too simplistic.</p>
<p>The fact that it's 10:12 now in Toronto isn't very helpful for a record
that's getting created for a user in Halifax and is monitored from
Vancouver.</p>
<p>So it's probably best to save timestamps WITH their timezone so as to
avoid any ambiguity. This is the recommendation given
<a class="reference external" href="http://justatheory.com/computers/databases/postgresql/use-timestamptz.html">here</a>.</p>
<p>In our above example, the simplest approach is to change the table
definition:</p>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">DROP</span> <span class="n">TABLE</span> <span class="n">IF</span> <span class="n">EXISTS</span> <span class="n">test</span><span class="p">;</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">test</span><span class="p">(</span><span class="n">name</span> <span class="n">TEXT</span><span class="p">,</span> <span class="n">created</span> <span class="n">TIMESTAMP</span> <span class="n">WITH</span> <span class="n">TIME</span> <span class="n">ZONE</span> <span class="n">DEFAULT</span> <span class="p">(</span><span class="n">NOW</span><span class="p">()</span> <span class="p">));</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">test</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;zaphod beeblebrox&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">test</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">created</span><span class="p">)</span> <span class="n">VALUES</span><span class="p">(</span><span class="s1">&#39;ford prefect&#39;</span><span class="p">,</span><span class="n">now</span><span class="p">()</span> <span class="p">);</span>
<span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">test</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>created</th>
    </tr>
    <tr>
        <td>zaphod beeblebrox</td>
        <td>2014-08-18 22:35:15.988764-04:00</td>
    </tr>
    <tr>
        <td>ford prefect</td>
        <td>2014-08-18 22:35:15.989726-04:00</td>
    </tr>
</table><p>So now the dates are globally meaningful. But I <em>still</em> have to be
careful, because if I use the wrong date format to populate this table,
it'll still get messed up.</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">test</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">created</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;arthur dent&#39;</span><span class="p">,</span><span class="n">now</span><span class="p">()</span> <span class="n">at</span> <span class="n">time</span> <span class="n">zone</span> <span class="s1">&#39;utc&#39;</span><span class="p">)</span>
<span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">test</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>created</th>
    </tr>
    <tr>
        <td>zaphod beeblebrox</td>
        <td>2014-08-18 22:35:15.988764-04:00</td>
    </tr>
    <tr>
        <td>ford prefect</td>
        <td>2014-08-18 22:35:15.989726-04:00</td>
    </tr>
    <tr>
        <td>arthur dent</td>
        <td>2014-08-19 02:35:15.990308-04:00</td>
    </tr>
</table><p>Note how <strong>arthur dent</strong> has completely the wrong created time.</p>
<p>Now, if I want to <em>report</em> on this data, I'm going to now have to
specify <em>which</em> timezone I want the dates formatted too:</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">delete</span> <span class="kn">from</span> <span class="nn">test</span> <span class="nn">WHERE</span> <span class="nn">name</span><span class="o">=</span><span class="s1">&#39;arthur dent&#39;</span><span class="p">;</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">select</span> <span class="n">name</span><span class="p">,</span> <span class="n">created</span> <span class="n">FROM</span> <span class="n">test</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>created</th>
    </tr>
    <tr>
        <td>zaphod beeblebrox</td>
        <td>2014-08-18 22:35:15.988764-04:00</td>
    </tr>
    <tr>
        <td>ford prefect</td>
        <td>2014-08-18 22:35:15.989726-04:00</td>
    </tr>
</table><p>gives me timestamps formatted in the timezone of the database server,
which isn't necessarily particularly helpful, which <em>may</em> be helpful,
but will be less so if the actual <em>users</em> of the data are in a different
time zone.</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span>  <span class="n">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">created</span> <span class="n">at</span> <span class="n">time</span> <span class="n">zone</span> <span class="s1">&#39;utc&#39;</span> <span class="n">FROM</span> <span class="n">test</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>timezone</th>
    </tr>
    <tr>
        <td>zaphod beeblebrox</td>
        <td>2014-08-19 02:35:15.988764</td>
    </tr>
    <tr>
        <td>ford prefect</td>
        <td>2014-08-19 02:35:15.989726</td>
    </tr>
</table><p>gives me the time formatted in the UTC timezone, and</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">select</span> <span class="n">CREATED</span> <span class="n">at</span> <span class="n">time</span> <span class="n">zone</span> <span class="s1">&#39;CST&#39;</span> <span class="n">FROM</span> <span class="n">test</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>timezone</th>
    </tr>
    <tr>
        <td>2014-08-18 20:35:15.988764</td>
    </tr>
    <tr>
        <td>2014-08-18 20:35:15.989726</td>
    </tr>
</table><p>gives me the time formatted for central standard time.</p>
<div class="section" id="external-data">
<h2>external data</h2>
<p>Now so far we've been letting the database create the timestamps, but
sometimes we want to save data provided to us from an external source.
In this case it's very important the we know what timezone the incoming
data comes from. So our middleware should <em>require</em> that all dates
include a timestamp. Fortunately, if we're writing javascript
applications, we get this automatically:</p>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">html</span>
<span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;js-output&quot;</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>
<div id="js-output"></div><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">javascript</span>
<span class="n">var</span> <span class="n">d</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">new</span> <span class="n">Date</span><span class="p">())</span>
</pre></div>
<pre class="literal-block">
&quot;2014-08-19T02:41:12.872Z&quot;
</pre>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span><span class="o">,</span><span class="nn">pandas</span>
<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
    <span class="k">with</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
</pre></div>
<p>So let's imagine that we got this string submitted to us by a client,
and we're going to store it in the database via some Python code.</p>
<div class="highlight"><pre><span></span><span class="n">sql</span><span class="o">=</span><span class="s2">&quot;INSERT INTO test (name, created) VALUES ( &#39;externally created date&#39;, </span><span class="si">%(date)s</span><span class="s2">)&quot;</span>
<span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="s2">&quot;2014-08-19T02:35:24.321Z&quot;</span><span class="p">)</span>
<span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">test</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>created</th>
    </tr>
    <tr>
        <td>zaphod beeblebrox</td>
        <td>2014-08-18 22:35:15.988764-04:00</td>
    </tr>
    <tr>
        <td>ford prefect</td>
        <td>2014-08-18 22:35:15.989726-04:00</td>
    </tr>
    <tr>
        <td>externally created date</td>
        <td>2014-08-18 22:35:24.321000-04:00</td>
    </tr>
</table><p>And now we're getting to the point where all our timestamp data is both
stored and displayed unambiguously.</p>
</div>


            </div>
        
    </section>

   




  
 
    
    <footer class="footer">
        <div class="container">
            <div class="content has-text-centered">
                <p>
                    Powered by <a href="http://getpelican.com/">Pelican</a>, <a href="http://python.org">Python</a>, 
                    and <a href="http://bulma.io/">Bulma</a>
                </p>
                <p class="subtitle is-6">Ubi Caritas et Amor, Deus Ibi Est</p>
            </div>
        </div>
    </footer>
</body>
</html>