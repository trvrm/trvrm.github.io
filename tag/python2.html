<!DOCTYPE html>
<html lang="en">
<head>
        <link href="/images/favicon.png" rel="icon">
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
        
        <title>trvrm.github.io</title>
            <link rel="stylesheet" type="text/css" href="/theme/css/flatly.min.css" />
        
        <link rel="stylesheet" type="text/css" href="/theme/css/style.css" />
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" />

        <link href="/theme/css/pygments/tango.css" rel="stylesheet">
        
</head>

<body>
    <section class="hero is-primary">
    <!-- Hero header: will stick at the top -->
    <div class="hero-head">
        <nav class="navbar  ">
            <div class="navbar-menu is-active">
                <div class="navbar-end">
                    <a class="navbar-item" href="https://twitter.com/trvrm">
                        <span class="icon"> <i class="fa fa-twitter"></i> </span>
                        twitter
                    </a>
                    <a class="navbar-item" href="https://github.com/trvrm">
                        <span class="icon"> <i class="fa fa-github"></i> </span>
                        github
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Hero content: will be in the middle -->
     <div class="hero-body">
            
             
             <div class="container has-text-centered">
               <p class="title is-1">trvrm.github.io</p>
               
    <h2>Articles tagged Python</h2>
             </div>
     </div>
     <div class="hero-foot">
         <nav class="navbar  ">
             
            <div class="navbar-brand is-active">
                <a href="/" class="navbar-item" >
                    trvrm.github.io
                </a>
            </div>
            <div class="navbar-menu is-active">
               <div class="navbar-start">
                   
                           <a class="navbar-item  " href="/category/database.html">Database</a>
                           <a class="navbar-item  " href="/category/software.html">Software</a>
                           <a class="navbar-item  " href="/category/systems.html">Systems</a>
               
                
               </div>
               
             </div>
           
         </nav>

     </div>
  </section>
  
  
  
  


  



    <section class="section">
        
            
            <p class="title is-3">
                <a href="/asynchronous-python.html" rel="bookmark" title="Permalink to Asynchronous Python">
                    Asynchronous Python
                </a>
            </p>
            <p class="subtitle is-5">
                Thu 01 January 2015
            </p>
            <hr>
            <div class="content ">
                <p>It's possible to get python to do node-like non-blocking requests, this could
take away one of the key reasons for using node.</p>
<p>The following is a full bottle-based python web application.</p>
<p>A client can sucessfully call /test while another client is waiting for
/slowproxy to return a result from a slow web service.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">monkey</span><span class="p">;</span> <span class="n">monkey</span><span class="o">.</span><span class="n">patch_all</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/sleep/&lt;seconds:int&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;Slept For {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/test&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
     <span class="k">return</span> <span class="s1">&#39;test&#39;</span>


<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/slowproxy/&lt;seconds:int&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">slowproxy</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">requests</span>
    <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://s.nooro.com/sleeptest.php?seconds=</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">seconds</span>
    <span class="n">response</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>

<span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span><span class="n">server</span><span class="o">=</span><span class="s1">&#39;gevent&#39;</span><span class="p">)</span>
</pre></div>
<p>My first attempt used grequests, but apparently that's not even necessary.</p>
<p>I guess that the call to monkey.patch_all() even patches the socket code
that requests uses.  I'm very impressed.</p>


            </div>
        
    </section>
    <section class="section">
        
            
            <p class="title is-3">
                <a href="/configuring-systems-with-fabric-and-cuisine.html" rel="bookmark" title="Permalink to Configuring Systems with Fabric and Cuisine">
                    Configuring Systems with Fabric and Cuisine
                </a>
            </p>
            <p class="subtitle is-5">
                Thu 01 January 2015
            </p>
            <hr>
            <div class="content ">
                <p>I've mentioned <a class="reference external" href="http://fabric.readthedocs.org/en/1.8/">Fabric</a> before on this blog.  Because so much of my development time is spent in Python, it makes
sense for me to look for system administration tools that are also written in Python.  Fabric fits the bill
perfectly, and allows me to run tasks remotely on multiple machines simultaneously.</p>
<p>A useful addition to Fabric is <a class="reference external" href="https://github.com/sebastien/cuisine">Cuisine</a>.  <strong>Cuisine is a small set of functions that sit on top of Fabric,
to abstract common administration operations such as file/dir operations, user/group creation,
package install/upgrade, making it easier to write portable administration and deployment scripts.</strong></p>


            </div>
        
    </section>
    <section class="section">
        
            
            <p class="title is-3">
                <a href="/ipython-with-python-3.html" rel="bookmark" title="Permalink to IPython with Python 3">
                    IPython with Python 3
                </a>
            </p>
            <p class="subtitle is-5">
                Thu 01 January 2015
            </p>
            <hr>
            <div class="content ">
                <p>This took me longer than I was expecting.</p>
<p>In general when working with IPython I use <code class="code">
pip</code>
 rather than <code class="code">
apt-get</code>
, as
pip tends to have more up-to-date packages.</p>
<p>In the end I found the simplest thing to do was to set up IPython in an isolated
virtualenv environment.  The main trick is to let virtualenv know what version of
Python you want it to use by default.</p>
<div class="highlight"><pre><span></span>$ virtualenv --python<span class="o">=</span>python3.4 python_3_demo
$ <span class="nb">cd</span> python_3_demo/
$ <span class="nb">source</span> ./bin/activate
$ pip install ipython
$ ipython
</pre></div>
<div class="highlight"><pre><span></span><span class="n">Python</span> <span class="mf">3.4</span><span class="o">.</span><span class="mi">0</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Apr</span> <span class="mi">11</span> <span class="mi">2014</span><span class="p">,</span> <span class="mi">13</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">11</span><span class="p">)</span>
<span class="o">...</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">sys</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
<span class="mf">3.4</span><span class="o">.</span><span class="mi">0</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Apr</span> <span class="mi">11</span> <span class="mi">2014</span><span class="p">,</span> <span class="mi">13</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">11</span><span class="p">)</span>
<span class="p">[</span><span class="n">GCC</span> <span class="mf">4.8</span><span class="o">.</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
<p>And voila, I have Python 3 in the best Python interpreter ever built, I'm ready to
start wrapping my head around byte arrays and UTF-8 encodings.</p>


            </div>
        
    </section>
    <section class="section">
        
            
            <p class="title is-3">
                <a href="/nginx-uwsgi-ubuntu-14.html" rel="bookmark" title="Permalink to Nginx and UWSGI on Ubuntu 14">
                    Nginx and UWSGI on Ubuntu 14
                </a>
            </p>
            <p class="subtitle is-5">
                Thu 01 January 2015
            </p>
            <hr>
            <div class="content ">
                <p>The documentation for Nginx and UWSGI is long and complex, but with ubuntu 14
it's actually pretty straightforward to get them up and running.</p>
<p>I present here a a setup that uses nginx and uwsgi emperor to host
multiple python web applications simultaneously on an ubuntu 14 machine.</p>
<p>First, the packages</p>
<div class="highlight"><pre><span></span>$ sudo apt-get install nginx
$ sudo apt-get install uwsgi uwsgi-emperor uwsgi-plugin-python
</pre></div>
<p>Our configuration files will now be under <code class="code">
/etc/nginx</code>
 and <code class="code">
/etc/uwsgi-emperor</code>
</p>
<p>You can start, stop, and reload nginx as follows:</p>
<div class="highlight"><pre><span></span>$ sudo service nginx start
$ sudo service nginx stop
$ sudo service nginx reload
</pre></div>
<p>The last command is useful when changing configuration settings.</p>
<p>Now set up a site by creating a file in <code class="code">
/etc/nginx/sites-available</code>
</p>
<div class="highlight"><pre><span></span><span class="c1">#/etc/nginx/sites-available/mysite</span>
server<span class="o">{</span>

    server_name     your_host_name<span class="p">;</span>

    location /app1 <span class="o">{</span>
        uwsgi_pass unix:/tmp/app1.socket<span class="p">;</span>
        include uwsgi_params<span class="p">;</span>
    <span class="o">}</span>
    location /app2 <span class="o">{</span>
        uwsgi_pass unix:/tmp/app2.socket<span class="p">;</span>
        include uwsgi_params<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>Then,</p>
<div class="highlight"><pre><span></span>$ sudo ln -s /etc/nginx/apps-available/mysite /etc/nginx/sites-enabled
</pre></div>
<div class="alert  alert-warning compound">
<p class="compound-first"><strong>Warning</strong></p>
<p class="compound-last">A previous version of this tutorial had the sockets placed in <code class="code">
/run/uwsgi</code>
.
This was a mistake, because under Ubuntu <code class="code">
/run</code>
 is mounted as a <code class="code">
tmpfs</code>
, and its content will be deleted on reboot
Your uwsgi sub-directory will vanish and the uwsgi services will not restart.</p>
</div>
<p>Next, set up your 'vassals' (<a class="reference external" href="http://uwsgi-docs.readthedocs.org/en/latest/Emperor.html">http://uwsgi-docs.readthedocs.org/en/latest/Emperor.html</a>)</p>
<p>Create  <code class="code">
/etc/uwsgi-emperor/vassals/app1.ini</code>
 as follows:</p>
<div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">plugin</span> <span class="o">=</span> <span class="s">python</span>
<span class="na">processes</span> <span class="o">=</span> <span class="s">2</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">/tmp/app1.socket</span>
<span class="na">chmod-socket</span> <span class="o">=</span> <span class="s">666</span>

<span class="na">chdir</span> <span class="o">=</span> <span class="s">/srv/app1</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">/srv/app1/main.py</span>

<span class="na">uid</span> <span class="o">=</span> <span class="s">www-data</span>
<span class="na">gid</span> <span class="o">=</span> <span class="s">www-data</span>
</pre></div>
<p>And for your second application, create  <code class="code">
/etc/uwsgi-emperor/vassals/app2.ini</code>
 as similarly:</p>
<div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">plugin</span> <span class="o">=</span> <span class="s">python</span>
<span class="na">processes</span> <span class="o">=</span> <span class="s">2</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">/tmp/app2.socket</span>
<span class="na">chmod-socket</span> <span class="o">=</span> <span class="s">666</span>

<span class="na">chdir</span> <span class="o">=</span> <span class="s">/srv/app1</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">/srv/app2/main.py</span>

<span class="na">uid</span> <span class="o">=</span> <span class="s">www-data</span>
<span class="na">gid</span> <span class="o">=</span> <span class="s">www-data</span>
</pre></div>
<p>The simple act of <em>creating</em> or touching a .ini file in <code class="code">
/etc/uwsgi-emperor/vassals</code>
 will cause
the emperor process to try to restart your application.</p>
<p>Of course, your applications don't exist yet, so let's create them.  The simplest wsgi
application can be only a few lines long:</p>
<p>Create <code class="code">
/srv/app1/main.py</code>
</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span><span class="s1">&#39;text/html&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;Hello World, I am app1&quot;</span><span class="p">]</span>
</pre></div>
<p>And <code class="code">
/srv/app2/main.py</code>
</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span><span class="s1">&#39;text/html&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;I, however, am app2. &quot;</span><span class="p">]</span>
</pre></div>
<p>And that's it!</p>
<p>Visiting <a class="reference external" href="http://your_host_name/app1">http://your_host_name/app1</a> or <a class="reference external" href="http://your_host_name/app2">http://your_host_name/app2</a> should return the text
you put in the python files.</p>


            </div>
        
    </section>
    <section class="section">
        
            
            <p class="title is-3">
                <a href="/pdf-generation-with-pelican.html" rel="bookmark" title="Permalink to PDF Generation With Pelican">
                    PDF Generation With Pelican
                </a>
            </p>
            <p class="subtitle is-5">
                Thu 01 January 2015
            </p>
            <hr>
            <div class="content ">
                <p>The existing documentation is a little unclear on this, because it says
you need to add <code class="code">
PDF_GENERATOR=True</code>
 to your <cite>pelicanconf.py</cite> file.</p>
<p>This advice is out of date: PDF generation has been moved to a plugin.</p>
<p>So you need to first make sure you have <code class="code">
rst2pdf</code>
 installed:</p>
<div class="highlight"><pre><span></span>$ sudo apt-get install rst2pdf
</pre></div>
<p>and then add the following to <code class="code">
pelicanconf.py</code>
</p>
<div class="highlight"><pre><span></span><span class="n">PLUGIN_PATH</span> <span class="o">=</span> <span class="s1">&#39;../pelican-plugins&#39;</span>  <span class="c1"># or wherever.</span>
<span class="n">PLUGINS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pdf&#39;</span><span class="p">]</span>
</pre></div>
<p>However, doing this seems to screw up the pygments highlighting on my regular
html output.  This is because deep in the rst2pdf code, in a file called <code class="code">
pygments2style.py</code>
,
all the pygment elements have their CSS classes prepended with <code class="code">
pygment-</code>
.  I haven't
figured out how to generate HTML and PDF nicely at the same time.</p>


            </div>
        
    </section>
    <section class="section">
        
            
            <p class="title is-3">
                <a href="/postgres-json-aggregation.html" rel="bookmark" title="Permalink to Postgres JSON Aggregation">
                    Postgres JSON Aggregation
                </a>
            </p>
            <p class="subtitle is-5">
                Thu 01 January 2015
            </p>
            <hr>
            <div class="content ">
                <p>I've been using the new JSON functionality in Postgres a lot recently:
I'm fond of saying that Postgresql is the best NoSQL database available
today. I'm quite serious about this: having used key-value and JSON
stores such as CouchDB in the past, it's amazing to me how the Postgres
developers have managed to marry the best of traditional relational
technology with the flexibility of schema-free JSON documents.</p>
<p>As of version 9.3, postgres allows you to create JSON column types, and
provides a number of functions to access and iterate through the data
stored in them.</p>
<p>This week I discovered another hidden gem - <code class="code">
json_agg()</code>
. This
function lets you take the results from an aggregation operation and
convert them into a JSON block - very helpful if you're then going to
work with the returned data in a language like Python</p>
<p>To demonstrate this, we'll first set up some simple tables.</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">load_ext</span> <span class="n">sql</span>
<span class="o">%</span><span class="n">config</span> <span class="n">SqlMagic</span><span class="o">.</span><span class="n">feedback</span><span class="o">=</span><span class="bp">False</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">postgresql</span><span class="p">:</span><span class="o">//</span><span class="n">testuser</span><span class="p">:</span><span class="n">password</span><span class="nd">@localhost</span><span class="o">/</span><span class="n">test</span>
</pre></div>
<pre class="literal-block">
u'Connected: <a class="reference external" href="mailto:testuser&#64;test">testuser&#64;test</a>'
</pre>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">IF</span> <span class="n">NOT</span> <span class="n">EXISTS</span> <span class="n">person</span> <span class="p">(</span>
    <span class="n">name</span> <span class="n">text</span> <span class="n">primary</span> <span class="n">key</span>
<span class="p">);</span>

<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">person</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="n">VALUES</span>
<span class="p">(</span><span class="s1">&#39;emily&#39;</span><span class="p">),(</span><span class="s1">&#39;arthur&#39;</span><span class="p">),(</span><span class="s1">&#39;nicki&#39;</span><span class="p">),(</span><span class="s1">&#39;oliver&#39;</span><span class="p">)</span>
<span class="p">;</span>
</pre></div>
<pre class="literal-block">
[]
</pre>
<p>We can query this in the usual way:</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">person</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered  is-striped is-bordered">
    <tr>
        <th>name</th>
    </tr>
    <tr>
        <td>emily</td>
    </tr>
    <tr>
        <td>arthur</td>
    </tr>
    <tr>
        <td>nicki</td>
    </tr>
    <tr>
        <td>oliver</td>
    </tr>
</table><p>But we can also use <code class="code">
json_agg()</code>
</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">json_agg</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">person</span>
</pre></div>
<table class="table table-bordered  is-striped is-bordered">
    <tr>
        <th>json_agg</th>
    </tr>
    <tr>
        <td>[u'emily', u'arthur', u'nicki', u'oliver']</td>
    </tr>
</table><p>Which gives us a single object to work with. So far, this isn't
particularly helpful, but it becomes very useful when we start doing
<code class="code">
JOINS</code>
</p>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">IF</span> <span class="n">NOT</span> <span class="n">EXISTS</span> <span class="n">action</span><span class="p">(</span>
    <span class="nb">id</span> <span class="n">serial</span> <span class="n">primary</span> <span class="n">key</span><span class="p">,</span>
    <span class="n">created</span> <span class="n">timestamp</span> <span class="k">with</span> <span class="n">time</span> <span class="n">zone</span> <span class="n">default</span> <span class="n">now</span><span class="p">(),</span>
    <span class="n">person_name</span> <span class="n">text</span> <span class="n">references</span> <span class="n">person</span><span class="p">,</span>
    <span class="nb">type</span> <span class="n">text</span> <span class="ow">not</span> <span class="n">null</span>
<span class="p">);</span>

<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;emily&#39;</span><span class="p">,</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;emily&#39;</span><span class="p">,</span><span class="s1">&#39;pageview&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;arthur&#39;</span><span class="p">,</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;emily&#39;</span><span class="p">,</span><span class="s1">&#39;logout&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;nicki&#39;</span><span class="p">,</span><span class="s1">&#39;password_change&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">action</span><span class="p">(</span><span class="n">person_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;nicki&#39;</span><span class="p">,</span><span class="s1">&#39;createpost&#39;</span><span class="p">);</span>
</pre></div>
<pre class="literal-block">
[]
</pre>
<p>If we want to ask Postgres to give us every user and every action
they've performed, we <em>could</em> do it this way:</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  <span class="n">action</span><span class="o">.</span><span class="n">type</span> <span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">created</span> <span class="n">FROM</span> <span class="n">action</span> <span class="n">JOIN</span> <span class="n">person</span> <span class="n">ON</span> <span class="n">action</span><span class="o">.</span><span class="n">person_name</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
<table class="table table-bordered  is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>type</th>
        <th>created</th>
    </tr>
    <tr>
        <td>emily</td>
        <td>login</td>
        <td>2014-11-08 17:45:05.963569-05:00</td>
    </tr>
    <tr>
        <td>emily</td>
        <td>pageview</td>
        <td>2014-11-08 17:45:05.964663-05:00</td>
    </tr>
    <tr>
        <td>arthur</td>
        <td>login</td>
        <td>2014-11-08 17:45:05.965214-05:00</td>
    </tr>
    <tr>
        <td>emily</td>
        <td>logout</td>
        <td>2014-11-08 17:45:05.965741-05:00</td>
    </tr>
    <tr>
        <td>nicki</td>
        <td>password_change</td>
        <td>2014-11-08 17:45:05.966274-05:00</td>
    </tr>
    <tr>
        <td>nicki</td>
        <td>createpost</td>
        <td>2014-11-08 17:45:05.966824-05:00</td>
    </tr>
</table><p>But then iterating through this recordset is a pain - I can't easily
construct a nested for loop to iterate through each person and then
through each action.</p>
<p>Enter <code class="code">
json_agg()</code>
</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  <span class="n">json_agg</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">action</span> <span class="n">JOIN</span> <span class="n">person</span> <span class="n">ON</span> <span class="n">action</span><span class="o">.</span><span class="n">person_name</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
<table class="table table-bordered is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>json_agg</th>
    </tr>
    <tr>
        <td>arthur</td>
        <td>[{u'person_name': u'arthur', u'type': u'login', u'id': 3, u'created': u'2014-11-08 17:45:05.965214-05'}]</td>
    </tr>
    <tr>
        <td>emily</td>
        <td>[{u'person_name': u'emily', u'type': u'login', u'id': 1, u'created': u'2014-11-08 17:45:05.963569-05'}, {u'person_name': u'emily', u'type': u'pageview', u'id': 2, u'created': u'2014-11-08 17:45:05.964663-05'}, {u'person_name': u'emily', u'type': u'logout', u'id': 4, u'created': u'2014-11-08 17:45:05.965741-05'}]</td>
    </tr>
    <tr>
        <td>nicki</td>
        <td>[{u'person_name': u'nicki', u'type': u'password_change', u'id': 5, u'created': u'2014-11-08 17:45:05.966274-05'}, {u'person_name': u'nicki', u'type': u'createpost', u'id': 6, u'created': u'2014-11-08 17:45:05.966824-05'}]</td>
    </tr>
</table><p>Which becomes much more usable in Python:</p>
<div class="highlight"><pre><span></span><span class="n">people</span> <span class="o">=</span> <span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  <span class="n">json_agg</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">action</span> <span class="n">JOIN</span> <span class="n">person</span> <span class="n">ON</span> <span class="n">action</span><span class="o">.</span><span class="n">person_name</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">actions</span> <span class="ow">in</span> <span class="n">people</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">name</span>
</pre></div>
<pre class="literal-block">
arthur
emily
nicki
</pre>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">actions</span> <span class="ow">in</span> <span class="n">people</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">name</span>
    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">action</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
</pre></div>
<pre class="literal-block">
arthur
    login
emily
    login
    pageview
    logout
nicki
    password_change
    createpost
</pre>
<p>So now we've managed to easily convert relational Postgres data into a
hierarchical Python data structure. From here we can easily continue to
XML, JSON, HTML or whatever document type suits your need.</p>


            </div>
        
    </section>
    <section class="section">
        
            
            <p class="title is-3">
                <a href="/postgres-timestamps.html" rel="bookmark" title="Permalink to Postgres Timestamps">
                    Postgres Timestamps
                </a>
            </p>
            <p class="subtitle is-5">
                Thu 01 January 2015
            </p>
            <hr>
            <div class="content ">
                <p>At my company, I maintain a large distributed. data collection platform
. Pretty much every record we collect needs to be stamped with a
<code class="code">
created</code>
 field. But because the incoming data comes from sources on
various devices in multiple countries and timezones, making sure that
the timestamps are precise and meaningful can be a challenge.
<a class="reference external" href="http://www.postgresql.org/">Postgres</a> can do this very elegantly,
but can also trip you up in subtle ways.</p>
<p>Postgres has two subtly different timestamp data types: <code class="code">
TIMESTAMP</code>

and <code class="code">
TIMESTAMP WITH TIMEZONE</code>
.</p>
<p>The former stores year/month/day/hour/minutes/second/milliseconds, as
you’d expect, and the later ALSO stores a timezone offset, expressed in
hours.</p>
<p>We can switch between the two using the <code class="code">
AT TIMEZONE</code>
 syntax, but, and
here is the tricky bit the function goes BOTH WAYS, and you can easily
get confused if you don’t know what type you’re starting with.</p>
<p>Furthermore, Postgres will sometimes sneakily convert one to the other
without you asking.</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">load_ext</span> <span class="n">sql</span>
<span class="o">%</span><span class="n">config</span> <span class="n">SqlMagic</span><span class="o">.</span><span class="n">feedback</span><span class="o">=</span><span class="bp">False</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">postgresql</span><span class="p">:</span><span class="o">//</span><span class="n">testuser</span><span class="p">:</span><span class="n">password</span><span class="nd">@localhost</span><span class="o">/</span><span class="n">test</span>
</pre></div>
<pre class="literal-block">
u'Connected: <a class="reference external" href="mailto:testuser&#64;test">testuser&#64;test</a>'
</pre>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">NOW</span><span class="p">();</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>now</th>
    </tr>
    <tr>
        <td>2014-08-18 22:33:58.998549-04:00</td>
    </tr>
</table><p><code class="code">
now()</code>
 returns a <code class="code">
TIMESTAMP WITH TIME ZONE</code>
. It shows the current
<strong>local</strong> time, and the offset between that time and UTC
(<a class="reference external" href="http://time.is/UTC">http://time.is/UTC</a>)</p>
<p>But if we put the output from <code class="code">
now()</code>
 into a field that has type
<code class="code">
TIMESTAMP</code>
 we will get a silent conversion:</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">NOW</span><span class="p">()::</span> <span class="n">timestamp</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>now</th>
    </tr>
    <tr>
        <td>2014-08-18 22:33:58.998549</td>
    </tr>
</table><p>Which is <strong>not</strong> the current UTC time. We have stripped the timezone
offset right of it. However, if we <strong>explicitly</strong> do the conversion, we
get:</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="n">NOW</span><span class="p">()</span> <span class="n">AT</span> <span class="n">TIME</span> <span class="n">ZONE</span> <span class="s1">&#39;UTC&#39;</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>timezone</th>
    </tr>
    <tr>
        <td>2014-08-19 02:33:58.998549</td>
    </tr>
</table><p>Which <em>is</em> the current UTC time: (<a class="reference external" href="http://time.is/UTC">http://time.is/UTC</a>)</p>
<p>It's worth reviewing the <a class="reference external" href="http://www.postgresql.org/docs/9.1/static/functions-datetime.html#FUNCTIONS-DATETIME-ZONECONVERT-TABLE">Postgresql documentation on this
construct</a>
at this point.</p>
<table class="table table-bordered">
<tr><th><p>Expression</p>
</th><th><p>Return Type</p>
</th><th><p>Description</p>
</th></tr>
<tr><td><p>timestamp without time zone AT TIME ZONE zone</p>
</td><td><p>timestamp with time zone</p>
</td><td><p>Treat given time stamp without time zone as located in the specified
time zone</p>
</td></tr>
<tr><td><p>timestamp with time zone AT TIME ZONE zone</p>
</td><td><p>timestamp without time zone</p>
</td><td><p>Convert given time stamp with time zone to the new time zone, with no
time zone designation</p>
</td></tr><table class="table table-bordered table-striped is-striped is-bordered"><p>The danger here is that the <code class="code">
AT TIMEZONE</code>
 construct goes <strong>both
ways</strong>. If you don't know what type you're feeding in, you won't know
what type you're getting out. I've been bitten by this in the past;
ending up with a timestamp that is wrong by several hours because I
wasn't clear about my inputs.</p>
<p>Specifically, consider a table that looks like this:</p>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">DROP</span> <span class="n">TABLE</span> <span class="n">IF</span> <span class="n">EXISTS</span> <span class="n">test</span><span class="p">;</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">test</span><span class="p">(</span><span class="n">name</span> <span class="n">TEXT</span><span class="p">,</span> <span class="n">created</span> <span class="n">TIMESTAMP</span> <span class="n">DEFAULT</span> <span class="n">NOW</span><span class="p">());</span>
</pre></div>
<p>Which I then populate:</p>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">test</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;zaphod beeblebrox&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">test</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">created</span><span class="p">)</span> <span class="n">VALUES</span><span class="p">(</span><span class="s1">&#39;ford prefect&#39;</span><span class="p">,</span><span class="n">now</span><span class="p">()</span> <span class="n">at</span> <span class="n">time</span> <span class="n">zone</span> <span class="s1">&#39;utc&#39;</span><span class="p">);</span>
<span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">test</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>created</th>
    </tr>
    <tr>
        <td>zaphod beeblebrox</td>
        <td>2014-08-18 22:34:03.620583</td>
    </tr>
    <tr>
        <td>ford prefect</td>
        <td>2014-08-19 02:34:03.621957</td>
    </tr>
</table><p>Note that the second record contains the current UTC time, but the first
contains the current time <strong>local to the database server</strong>. This <em>seems</em>
a good idea, and tends to work fine in local testing. But when you try
to maintain a system where the database may be in one province, the data
<em>collected</em> in another, and then <em>reviewed</em> in a third, you start to
understand why this is too simplistic.</p>
<p>The fact that it's 10:12 now in Toronto isn't very helpful for a record
that's getting created for a user in Halifax and is monitored from
Vancouver.</p>
<p>So it's probably best to save timestamps WITH their timezone so as to
avoid any ambiguity. This is the recommendation given
<a class="reference external" href="http://justatheory.com/computers/databases/postgresql/use-timestamptz.html">here</a>.</p>
<p>In our above example, the simplest approach is to change the table
definition:</p>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">DROP</span> <span class="n">TABLE</span> <span class="n">IF</span> <span class="n">EXISTS</span> <span class="n">test</span><span class="p">;</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">test</span><span class="p">(</span><span class="n">name</span> <span class="n">TEXT</span><span class="p">,</span> <span class="n">created</span> <span class="n">TIMESTAMP</span> <span class="n">WITH</span> <span class="n">TIME</span> <span class="n">ZONE</span> <span class="n">DEFAULT</span> <span class="p">(</span><span class="n">NOW</span><span class="p">()</span> <span class="p">));</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">sql</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">test</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;zaphod beeblebrox&#39;</span><span class="p">);</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">test</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">created</span><span class="p">)</span> <span class="n">VALUES</span><span class="p">(</span><span class="s1">&#39;ford prefect&#39;</span><span class="p">,</span><span class="n">now</span><span class="p">()</span> <span class="p">);</span>
<span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">test</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>created</th>
    </tr>
    <tr>
        <td>zaphod beeblebrox</td>
        <td>2014-08-18 22:35:15.988764-04:00</td>
    </tr>
    <tr>
        <td>ford prefect</td>
        <td>2014-08-18 22:35:15.989726-04:00</td>
    </tr>
</table><p>So now the dates are globally meaningful. But I <em>still</em> have to be
careful, because if I use the wrong date format to populate this table,
it'll still get messed up.</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">test</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">created</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;arthur dent&#39;</span><span class="p">,</span><span class="n">now</span><span class="p">()</span> <span class="n">at</span> <span class="n">time</span> <span class="n">zone</span> <span class="s1">&#39;utc&#39;</span><span class="p">)</span>
<span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">test</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>created</th>
    </tr>
    <tr>
        <td>zaphod beeblebrox</td>
        <td>2014-08-18 22:35:15.988764-04:00</td>
    </tr>
    <tr>
        <td>ford prefect</td>
        <td>2014-08-18 22:35:15.989726-04:00</td>
    </tr>
    <tr>
        <td>arthur dent</td>
        <td>2014-08-19 02:35:15.990308-04:00</td>
    </tr>
</table><p>Note how <strong>arthur dent</strong> has completely the wrong created time.</p>
<p>Now, if I want to <em>report</em> on this data, I'm going to now have to
specify <em>which</em> timezone I want the dates formatted too:</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">delete</span> <span class="kn">from</span> <span class="nn">test</span> <span class="nn">WHERE</span> <span class="nn">name</span><span class="o">=</span><span class="s1">&#39;arthur dent&#39;</span><span class="p">;</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">select</span> <span class="n">name</span><span class="p">,</span> <span class="n">created</span> <span class="n">FROM</span> <span class="n">test</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>created</th>
    </tr>
    <tr>
        <td>zaphod beeblebrox</td>
        <td>2014-08-18 22:35:15.988764-04:00</td>
    </tr>
    <tr>
        <td>ford prefect</td>
        <td>2014-08-18 22:35:15.989726-04:00</td>
    </tr>
</table><p>gives me timestamps formatted in the timezone of the database server,
which isn't necessarily particularly helpful, which <em>may</em> be helpful,
but will be less so if the actual <em>users</em> of the data are in a different
time zone.</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span>  <span class="n">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">created</span> <span class="n">at</span> <span class="n">time</span> <span class="n">zone</span> <span class="s1">&#39;utc&#39;</span> <span class="n">FROM</span> <span class="n">test</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>timezone</th>
    </tr>
    <tr>
        <td>zaphod beeblebrox</td>
        <td>2014-08-19 02:35:15.988764</td>
    </tr>
    <tr>
        <td>ford prefect</td>
        <td>2014-08-19 02:35:15.989726</td>
    </tr>
</table><p>gives me the time formatted in the UTC timezone, and</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">select</span> <span class="n">CREATED</span> <span class="n">at</span> <span class="n">time</span> <span class="n">zone</span> <span class="s1">&#39;CST&#39;</span> <span class="n">FROM</span> <span class="n">test</span><span class="p">;</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>timezone</th>
    </tr>
    <tr>
        <td>2014-08-18 20:35:15.988764</td>
    </tr>
    <tr>
        <td>2014-08-18 20:35:15.989726</td>
    </tr>
</table><p>gives me the time formatted for central standard time.</p>
<div class="section" id="external-data">
<h2>external data</h2>
<p>Now so far we've been letting the database create the timestamps, but
sometimes we want to save data provided to us from an external source.
In this case it's very important the we know what timezone the incoming
data comes from. So our middleware should <em>require</em> that all dates
include a timestamp. Fortunately, if we're writing javascript
applications, we get this automatically:</p>
<div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">html</span>
<span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;js-output&quot;</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>
<div id="js-output"></div><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">javascript</span>
<span class="n">var</span> <span class="n">d</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">new</span> <span class="n">Date</span><span class="p">())</span>
</pre></div>
<pre class="literal-block">
&quot;2014-08-19T02:41:12.872Z&quot;
</pre>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span><span class="o">,</span><span class="nn">pandas</span>
<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
    <span class="k">with</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
</pre></div>
<p>So let's imagine that we got this string submitted to us by a client,
and we're going to store it in the database via some Python code.</p>
<div class="highlight"><pre><span></span><span class="n">sql</span><span class="o">=</span><span class="s2">&quot;INSERT INTO test (name, created) VALUES ( &#39;externally created date&#39;, </span><span class="si">%(date)s</span><span class="s2">)&quot;</span>
<span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="s2">&quot;2014-08-19T02:35:24.321Z&quot;</span><span class="p">)</span>
<span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">sql</span> <span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">test</span>
</pre></div>
<table class="table table-bordered table-striped is-striped is-bordered">
    <tr>
        <th>name</th>
        <th>created</th>
    </tr>
    <tr>
        <td>zaphod beeblebrox</td>
        <td>2014-08-18 22:35:15.988764-04:00</td>
    </tr>
    <tr>
        <td>ford prefect</td>
        <td>2014-08-18 22:35:15.989726-04:00</td>
    </tr>
    <tr>
        <td>externally created date</td>
        <td>2014-08-18 22:35:24.321000-04:00</td>
    </tr>
</table><p>And now we're getting to the point where all our timestamp data is both
stored and displayed unambiguously.</p>
</div>


            </div>
        
    </section>
    <section class="section">
        
            
            <p class="title is-3">
                <a href="/python-comprehensions.html" rel="bookmark" title="Permalink to Python Comprehensions">
                    Python Comprehensions
                </a>
            </p>
            <p class="subtitle is-5">
                Thu 01 January 2015
            </p>
            <hr>
            <div class="content ">
                <p>Python <strong>list comprehensions</strong> are one of the most powerful and useful
features of the language. However, I've noticed even quite experienced
Python programmers using less powerful idioms when a list comprehension
would be the perfect solution to their problem, and even though I've
been a Python developer for more than a decade, I've recently learned
some very nice aspects of this feature.</p>
<div class="section" id="what-s-a-list-comprehension">
<h2>What's a List Comprehension?</h2>
<p>Python is such a strong language in part because of its willingness to
steal ideas from other languages. Python list comprehensions are an idea
that comes from
<a class="reference external" href="http://www.haskell.org/haskellwiki/List_comprehension">Haskell</a>.
Fundamentally, they are a kind of 'syntactic sugar' for construct lists
from other data sources in a tight, elegant fashion.</p>
<p>One of the things I like most about them is they eliminate the need to
manually create loop structures and extra variables. So consider the
following:</p>
<div class="highlight"><pre><span></span><span class="n">squares</span><span class="o">=</span><span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">squares</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="n">i</span><span class="p">)</span>
<span class="n">squares</span>
</pre></div>
<pre class="literal-block">
[1, 1, 4, 27, 256, 3125, 46656, 823543, 16777216, 387420489]
</pre>
<p>With List Comprehensions we can eliminate both the <code class="code">
for</code>
 loop and the
calls to <code class="code">
append()</code>
</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="n">i</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
</pre></div>
<pre class="literal-block">
[1, 1, 4, 27, 256, 3125, 46656, 823543, 16777216, 387420489]
</pre>
<p>Comprehensions work with any kind of iterable as an import source:</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span> <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="s2">&quot;hello world&quot;</span><span class="p">]</span>
</pre></div>
<pre class="literal-block">
[104, 101, 108, 108, 111, 32, 119, 111, 114, 108, 100]
</pre>
</div>
<div class="section" id="multiple-generators">
<h2>Multiple generators</h2>
<p>To make things a little more complex, we can specifiy more than one
input data source:</p>
<div class="highlight"><pre><span></span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
</pre></div>
<pre class="literal-block">
[(0, 0), (0, 1), (0, 2), (1, 0), (1, 1), (1, 2)]
</pre>
<p>Instead of just boring numbers, we could use this to construct some
sentences.</p>
<div class="highlight"><pre><span></span><span class="p">[(</span><span class="n">number</span><span class="p">,</span> <span class="n">animal</span><span class="p">)</span> <span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cats&#39;</span><span class="p">,</span><span class="s1">&#39;dogs&#39;</span><span class="p">,</span><span class="s1">&#39;elephants&#39;</span><span class="p">]]</span>
</pre></div>
<pre class="literal-block">
[(0, 'cats'),
 (0, 'dogs'),
 (0, 'elephants'),
 (1, 'cats'),
 (1, 'dogs'),
 (1, 'elephants'),
 (2, 'cats'),
 (2, 'dogs'),
 (2, 'elephants')]
</pre>
<p>Furthermore, we have a lot of control over <em>how</em> we construct the final
output objects - we can put any valid python expression in the
left-hand-side.</p>
<div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="s2">&quot;{0} {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adjective</span><span class="p">,</span><span class="n">animal</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">adjective</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="s1">&#39;cute&#39;</span><span class="p">,</span><span class="s1">&#39;hungry&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span><span class="s1">&#39;puppy&#39;</span><span class="p">,</span><span class="s1">&#39;hippo&#39;</span><span class="p">]</span>
<span class="p">]</span>
</pre></div>
<pre class="literal-block">
['red cat',
 'red puppy',
 'red hippo',
 'cute cat',
 'cute puppy',
 'cute hippo',
 'hungry cat',
 'hungry puppy',
 'hungry hippo']
</pre>
<p>or even</p>
<div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="s2">&quot;There are {0} {1} {2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">adjective</span><span class="p">,</span><span class="n">animal</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">adjective</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cute&#39;</span><span class="p">,</span><span class="s1">&#39;hungry&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;puppys&#39;</span><span class="p">,</span><span class="s1">&#39;bats&#39;</span><span class="p">]</span>
<span class="p">]</span>
</pre></div>
<pre class="literal-block">
['There are 2 cute puppys',
 'There are 2 cute bats',
 'There are 2 hungry puppys',
 'There are 2 hungry bats',
 'There are 3 cute puppys',
 'There are 3 cute bats',
 'There are 3 hungry puppys',
 'There are 3 hungry bats']
</pre>
</div>
<div class="section" id="dictionary-comprehensions">
<h2>Dictionary Comprehensions</h2>
<p>An equally powerful construct is the <em>dictionary comprehension</em>. Just
like list comprehensions, this enables you to construct python
dictionaries using a very similar syntax.</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="n">key</span><span class="p">:</span><span class="n">value</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;v&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="s1">&#39;bar&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;this&#39;</span><span class="p">,</span><span class="s1">&#39;that&#39;</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
<pre class="literal-block">
{'foo': 'bar', 'k': 'v', 'this': 'that'}
</pre>
<p>Armed with these tools, we can write very concise code to transform data
from one structure to another. Recently I've found them <em>very</em> helpful
for unpacking nested data structures.</p>
<p>Consider a simple org-structure:</p>
<div class="highlight"><pre><span></span><span class="n">departments</span><span class="o">=</span><span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;Manufacturing&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Jacob&quot;</span><span class="p">,</span><span class="s2">&quot;Jonah&quot;</span><span class="p">,</span> <span class="s2">&quot;Chloe&quot;</span><span class="p">,</span><span class="s2">&quot;Liam&quot;</span><span class="p">]},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;Marketing&#39;</span><span class="p">,</span><span class="s1">&#39;staff&#39;</span><span class="p">:[</span><span class="s2">&quot;Emily&quot;</span><span class="p">,</span><span class="s2">&quot;Shawn&quot;</span><span class="p">,</span><span class="s2">&quot;Alex&quot;</span><span class="p">]},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;HR&#39;</span><span class="p">,</span><span class="s1">&#39;staff&#39;</span><span class="p">:[</span><span class="s2">&quot;David&quot;</span><span class="p">,</span><span class="s2">&quot;Jessica&quot;</span><span class="p">]},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;Accounts&#39;</span><span class="p">,</span><span class="s1">&#39;staff&#39;</span><span class="p">:[</span><span class="s2">&quot;Nicole&quot;</span><span class="p">]}</span>
<span class="p">]</span>
</pre></div>
<p>Now let's extract some data from it.</p>
<div class="highlight"><pre><span></span><span class="c1">#Department names</span>
<span class="p">[</span><span class="n">department</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">department</span> <span class="ow">in</span> <span class="n">departments</span><span class="p">]</span>
</pre></div>
<pre class="literal-block">
['Manufacturing', 'Marketing', 'HR', 'Accounts']
</pre>
<div class="highlight"><pre><span></span><span class="c1">#Staff count</span>
<span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">department</span><span class="p">[</span><span class="s1">&#39;staff&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">department</span> <span class="ow">in</span> <span class="n">departments</span><span class="p">])</span>
</pre></div>
<pre class="literal-block">
10
</pre>
<div class="highlight"><pre><span></span><span class="c1">#All staff names</span>
<span class="p">[</span>
    <span class="n">name</span>
    <span class="k">for</span> <span class="n">department</span> <span class="ow">in</span> <span class="n">departments</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">department</span><span class="p">[</span><span class="s1">&#39;staff&#39;</span><span class="p">]</span>
<span class="p">]</span>
</pre></div>
<pre class="literal-block">
['Jacob',
 'Jonah',
 'Chloe',
 'Liam',
 'Emily',
 'Shawn',
 'Alex',
 'David',
 'Jessica',
 'Nicole']
</pre>
<p>Note how in the last example the <em>second</em> data-generating clause,
<code class="code">
department['staff']</code>
, used a reference from the <em>first</em> one.</p>
<p>We can take this even further. Let's make our org-chart a little more
complicated...</p>
<div class="highlight"><pre><span></span><span class="n">departments</span><span class="o">=</span><span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;Manufacturing&#39;</span><span class="p">,</span>
        <span class="s1">&#39;staff&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s2">&quot;Jacob&quot;</span><span class="p">,</span><span class="s1">&#39;salary&#39;</span><span class="p">:</span><span class="mi">50000</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s2">&quot;Chloe&quot;</span><span class="p">,</span><span class="s1">&#39;salary&#39;</span><span class="p">:</span><span class="mi">60000</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s2">&quot;Liam&quot;</span><span class="p">,</span><span class="s1">&#39;salary&#39;</span><span class="p">:</span><span class="mi">70000</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s2">&quot;Jonah&quot;</span><span class="p">,</span><span class="s1">&#39;salary&#39;</span><span class="p">:</span><span class="mi">55000</span><span class="p">},</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;Marketing&#39;</span><span class="p">,</span>
        <span class="s1">&#39;staff&#39;</span><span class="p">:[</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s2">&quot;Emily&quot;</span><span class="p">,</span><span class="s1">&#39;salary&#39;</span><span class="p">:</span><span class="mi">50000</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s2">&quot;Shawn&quot;</span><span class="p">,</span><span class="s1">&#39;salary&#39;</span><span class="p">:</span><span class="mi">45000</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s2">&quot;Alex&quot;</span><span class="p">,</span><span class="s1">&#39;salary&#39;</span><span class="p">:</span><span class="mi">40000</span><span class="p">},</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;HR&#39;</span><span class="p">,</span>
        <span class="s1">&#39;staff&#39;</span><span class="p">:[</span>

            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s2">&quot;David&quot;</span><span class="p">,</span><span class="s1">&#39;salary&#39;</span><span class="p">:</span><span class="mi">50000</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s2">&quot;Jessica&quot;</span><span class="p">,</span><span class="s1">&#39;salary&#39;</span><span class="p">:</span><span class="mi">60000</span><span class="p">},</span>
       <span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;Accounts&#39;</span><span class="p">,</span>
        <span class="s1">&#39;staff&#39;</span><span class="p">:[</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s2">&quot;Nicole&quot;</span><span class="p">,</span><span class="s1">&#39;salary&#39;</span><span class="p">:</span><span class="mi">40000</span><span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
<p>Calculate the total salary:</p>
<div class="highlight"><pre><span></span><span class="nb">sum</span><span class="p">(</span>
    <span class="n">person</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">department</span> <span class="ow">in</span> <span class="n">departments</span>
    <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">department</span><span class="p">[</span><span class="s1">&#39;staff&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
<pre class="literal-block">
520000
</pre>
<p>Now let's calculate the wages bill by department, and put the results in
a dictionary</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="n">department</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">department</span><span class="p">[</span><span class="s1">&#39;staff&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">department</span> <span class="ow">in</span> <span class="n">departments</span>
<span class="p">}</span>
</pre></div>
<pre class="literal-block">
{'Accounts': 40000, 'HR': 110000, 'Manufacturing': 235000, 'Marketing': 135000}
</pre>
<div class="section" id="conclusion">
<h3>Conclusion</h3>
<p>I've been finding this type of approach <em>very</em> helpful when working with
document-oriented data stores. We store a lot of data in JSON documents,
either on the file system or in Postgresql. For that data to be useful,
we have to be able to quickly mine, explore, select and transform it.
Tools like <a class="reference external" href="http://jsonselect.org/#overview">JSONSelect</a> do exist,
but JSONSelect is only available in Javascript, and doesn't allow you to
do the kind of rich expression-based transforms as you roll up the data
that Python does.</p>
<p>I also find that it avoids many common programming pitfalls:
mis-assigned variables, off-by-one errors and so on. You'll note that in
all the examples above I <em>never</em> need to create a temporary variable or
explicitly construct a <code class="code">
for</code>
-loop.</p>
</div>
</div>


            </div>
        
    </section>

   


<section class="section">
    
        
        <nav class="pagination   is-centered" role="navigation" aria-label="pagination">
                
                <a href="/tag/python.html" class="pagination-previous">Previous</a>
                <a href="/tag/python3.html" class="pagination-next">Next</a>
            
            <ul class="pagination-list">
                    <li >
                        <a href="/tag/python.html"
                            class="pagination-link "    >
                            1
                        </a>
                    </li>
                    <li >
                        <a href="/tag/python2.html"
                            class="pagination-link is-current"    >
                            2
                        </a>
                    </li>
                    <li >
                        <a href="/tag/python3.html"
                            class="pagination-link "    >
                            3
                        </a>
                    </li>
            </ul>
            
            
            
        </nav>
    
    
</section>



  
 
    
    <footer class="footer">
        <div class="container">
            <div class="content has-text-centered">
                <p>
                    Powered by <a href="http://getpelican.com/">Pelican</a>, <a href="http://python.org">Python</a>, 
                    and <a href="http://bulma.io/">Bulma</a>
                </p>
                <p class="subtitle is-6">Ubi Caritas et Amor, Deus Ibi Est</p>
            </div>
        </div>
    </footer>
</body>
</html>